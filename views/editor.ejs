<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Professional Blog Editor - <%= postTitle || 'New Post' %></title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto&family=Lato&family=Montserrat&family=Open+Sans&family=Merriweather&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link rel="stylesheet" href="/css/editor.css" />
    
    <style>
        /* SEO Modal Styles */
        .seo-category-card {
            background: white;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .seo-category-card:hover {
            border-color: #d1d5db;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }
        
        #seo-score-modal > div {
            transform: scale(0.95);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        #seo-score-modal.flex > div {
            transform: scale(1);
            opacity: 1;
        }
        
        /* Keyword highlighting styles */
        .keyword-highlight {
            background: linear-gradient(120deg, #ffd700 0%, #ffed4a 100%);
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: 500;
            box-shadow: 0 1px 3px rgba(255, 215, 0, 0.3);
            animation: highlight-pulse 0.6s ease-out;
        }
        
        @keyframes highlight-pulse {
            0% {
                transform: scale(1);
                background: #ffd700;
            }
            50% {
                transform: scale(1.05);
                background: #ffed4a;
            }
            100% {
                transform: scale(1);
                background: linear-gradient(120deg, #ffd700 0%, #ffed4a 100%);
            }
        }
        
        /* XML display improvements */
        .xml-view {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            background: #1e293b;
            color: #e2e8f0;
            border-radius: 8px;
            border: 1px solid #334155;
        }
        
        .xml-view:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }

        /* Modal animations and improvements */
        .modal-backdrop {
            backdrop-filter: blur(4px);
            transition: all 0.3s ease-in-out;
        }

        .modal-content {
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1) translateY(0);
            }
        }

        .modal-exit {
            animation: modalSlideOut 0.2s ease-in;
        }

        @keyframes modalSlideOut {
            from {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1) translateY(0);
            }
            to {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.9) translateY(-20px);
            }
        }

        /* Form input focus improvements */
        .form-input:focus {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* Button hover effects */
        .modal-button {
            position: relative;
            overflow: hidden;
        }

        .modal-button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .modal-button:hover::before {
            width: 300px;
            height: 300px;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-6">
    
    <input type="hidden" id="postId" value="<%= typeof postId !== 'undefined' ? postId : '' %>">
    
    <form id="post-form" method="POST" action="/submit" class="max-w-screen-2xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-4">
                    <h1 class="text-2xl lg:text-3xl font-bold text-gray-800">CCTA BLOG</h1>
                    <span id="saveStatus" class="text-sm text-gray-500 opacity-0">Saving...</span>
                </div>
                <div class="flex items-center gap-2 lg:gap-4">
                    
                    <button type="button" id="mobile-ai-toggle" class="md:hidden p-2 text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" title="Toggle AI Tools">
                        <span class="material-symbols-outlined">psychology</span>
                    </button>
                    <button type="button" id="togglePreviewBtn" class="toolbar-button" title="Toggle Preview">
                        <span class="material-symbols-outlined">visibility_off</span>
                    </button>
                    <button type="button" id="saveDraftButton" class="px-3 py-2 lg:px-4 lg:py-2 bg-gray-500 text-white font-medium rounded-lg hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50 transition-colors text-sm lg:text-base">
                        <span class="hidden sm:inline">Save Draft</span>
                        <span class="sm:hidden">Save</span>
                    </button>
                    <button type="submit" id="publishButton" class="px-4 py-2 lg:px-6 lg:py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-colors text-sm lg:text-base">
                        <% if (typeof postStatus !== 'undefined' && postStatus === 'published') { %>
                            Update Post
                        <% } else { %>
                            Publish Blog
                        <% } %>
                    </button>
                </div>
            </div>
            
            <input type="hidden" name="postContent" id="postContent">
            <input type="hidden" name="postXml" id="postXml">
            <input type="hidden" name="seoData" id="seoData">
            <input type="hidden" name="metaDescription" id="metaDescriptionInput">
            <input type="hidden" name="focusKeyword" id="focusKeywordInput">
            <input type="hidden" name="urlSlug" id="urlSlugInput">
            <input type="hidden" name="canonicalUrl" id="canonicalUrlInput">
            <input type="hidden" name="ogTitle" id="ogTitleInput">
            <input type="hidden" name="ogDescription" id="ogDescriptionInput">
            <input type="hidden" name="postId" id="postIdField" value="<%= typeof postId !== 'undefined' ? postId : '' %>">
            
            <div class="mb-6">
                
                <input type="text" id="blogTitle" name="postTitle" class="w-full border border-gray-300 p-3 rounded-md text-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter your post title here..." value="<%= postTitle || '' %>">
            </div>

            <div class="editor-wrapper">
                
                <div id="toolbar-container" class="flex flex-wrap items-center gap-2 p-2 bg-gray-50 border-b border-gray-200 rounded-t-lg sticky top-0 z-20">
                    <div id="toolbar-content" class="flex flex-wrap items-center gap-2">
                        
                        <button type="button" id="undo" class="toolbar-button" title="Undo (Ctrl+Z)"><span class="material-symbols-outlined">undo</span></button>
                        <button type="button" id="redo" class="toolbar-button" title="Redo (Ctrl+Y)"><span class="material-symbols-outlined">redo</span></button>
                        
                        <div class="toolbar-separator h-6"></div>

                        <button type="button" id="bold" class="toolbar-button" title="Bold"><span class="material-symbols-outlined">format_bold</span></button>
                        <button type="button" id="italic" class="toolbar-button" title="Italic"><span class="material-symbols-outlined">format_italic</span></button>
                        <button type="button" id="underline" class="toolbar-button" title="Underline"><span class="material-symbols-outlined">format_underlined</span></button>
                        <button type="button" id="strikethrough" class="toolbar-button" title="Strikethrough"><span class="material-symbols-outlined">strikethrough_s</span></button>
                        <button type="button" id="superscript" class="toolbar-button" title="Superscript"><span class="material-symbols-outlined">superscript</span></button>
                        <button type="button" id="subscript" class="toolbar-button" title="Subscript"><span class="material-symbols-outlined">subscript</span></button>
                        
                        <div class="toolbar-separator h-6"></div>

                        <div class="custom-select-wrapper">
                            <select id="fontName" class="border-gray-300 text-gray-900 text-sm focus:ring-2 focus:ring-blue-500 block p-2.5">
                                <option value="Inter" selected>Inter</option>
                                <option value="Arial">Arial</option>
                                <option value="Roboto">Roboto</option>
                                <option value="Lato">Lato</option>
                                <option value="Montserrat">Montserrat</option>
                                <option value="Open Sans">Open Sans</option>
                                <option value="Merriweather">Merriweather</option>
                                <option value="Georgia">Georgia</option>
                                <option value="Times New Roman">Times New Roman</option>
                                <option value="Courier New">Courier New</option>
                            </select>
                            <span class="material-symbols-outlined">arrow_drop_down</span>
                        </div>
                        <div class="custom-select-wrapper">
                            <select id="fontSize" class="border-gray-300 text-gray-900 text-sm focus:ring-2 focus:ring-blue-500 block p-2.5">
                                <option value="1">Tiny</option>
                                <option value="2">Small</option>
                                <option value="3" selected>Normal</option>
                                <option value="4">Large</option>
                                <option value="5">XL</option>
                                <option value="6">XXL</option>
                                <option value="7">Huge</option>
                            </select>
                            <span class="material-symbols-outlined">arrow_drop_down</span>
                        </div>
                        <div class="color-well-wrapper toolbar-button" title="Text Color">
                            <span class="material-symbols-outlined">format_color_text</span>
                            <input type="color" id="foreColor" class="color-well">
                        </div>
                        <div class="color-well-wrapper toolbar-button" title="Highlight Color">
                            <span class="material-symbols-outlined">format_ink_highlighter</span>
                            <input type="color" id="backColor" class="color-well" value="#FFFF00">
                        </div>
                        
                        <div class="toolbar-separator h-6"></div>

                        <div class="custom-select-wrapper">
                            <select id="heading" class="border-gray-300 text-gray-900 text-sm focus:ring-2 focus:ring-blue-500 block p-2.5">
                                <option value="">Paragraph</option>
                                <option value="h1">Heading 1</option>
                                <option value="h2">Heading 2</option>
                                <option value="h3">Heading 3</option>
                                <option value="h4">Heading 4</option>
                            </select>
                            <span class="material-symbols-outlined">arrow_drop_down</span>
                        </div>

                        <div class="toolbar-separator h-6"></div>

                        <button type="button" id="justifyLeft" class="toolbar-button active" title="Align Left"><span class="material-symbols-outlined">format_align_left</span></button>
                        <button type="button" id="justifyCenter" class="toolbar-button" title="Align Center"><span class="material-symbols-outlined">format_align_center</span></button>
                        <button type="button" id="justifyRight" class="toolbar-button" title="Align Right"><span class="material-symbols-outlined">format_align_right</span></button>

                        <div class="toolbar-separator h-6"></div>

                        <button type="button" id="insertUnorderedList" class="toolbar-button" title="Bulleted List"><span class="material-symbols-outlined">format_list_bulleted</span></button>
                        <button type="button" id="insertOrderedList" class="toolbar-button" title="Numbered List"><span class="material-symbols-outlined">format_list_numbered</span></button>
                        <button type="button" id="indent" class="toolbar-button" title="Indent"><span class="material-symbols-outlined">format_indent_increase</span></button>
                        <button type="button" id="outdent" class="toolbar-button" title="Outdent"><span class="material-symbols-outlined">format_indent_decrease</span></button>

                        <div class="toolbar-separator h-6"></div>

                        <button type="button" id="createLink" class="toolbar-button" title="Add Link"><span class="material-symbols-outlined">link</span></button>
                        <button type="button" id="insertImage" class="toolbar-button" title="Add Image"><span class="material-symbols-outlined">image</span></button>
                        <button type="button" id="insertVideo" class="toolbar-button" title="Add Video"><span class="material-symbols-outlined">videocam</span></button>
                        <button type="button" id="insertTable" class="toolbar-button" title="Add Table"><span class="material-symbols-outlined">table_chart</span></button>
                        <button type="button" id="removeFormat" class="toolbar-button" title="Clear Formatting"><span class="material-symbols-outlined">format_clear</span></button>
                    </div>

                    <div class="ml-auto flex items-center gap-2">
                        
                        <div id="mini-seo-score" class="hidden bg-gradient-to-r from-blue-500 to-green-500 text-white px-3 py-1 rounded-full text-xs font-semibold cursor-pointer hover:shadow-lg transition-all" onclick="showSEOModal()" title="Click to view detailed SEO analysis">
                            SEO: <span id="mini-seo-number">0</span>/100
                        </div>
                        
                        <label for="xml-toggle" class="text-sm font-medium text-gray-700">XML</label>
                        <button type="button" id="xml-toggle" class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <span id="xml-toggle-handle" class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform translate-x-1"></span>
                        </button>
                        <button type="button" id="advancedSeoButton" class="inline-flex items-center px-3 py-1.5 ml-2 text-sm font-semibold text-blue-600 bg-blue-50 hover:bg-blue-100 border border-blue-200 rounded-md transition-colors" title="Advanced SEO Settings">
                            Advanced SEO Settings
                        </button>
                        <button type="button" id="toggleToolbarBtn" class="toolbar-button ml-2" title="Hide Toolbar">
                            <span class="material-symbols-outlined">keyboard_arrow_up</span>
                        </button>
                    </div>
                </div>

                <div id="content-wrapper" class="flex w-full" style="position: relative;">
                    
                    <div id="main-container" class="flex flex-grow">
                        <div id="editor-pane" class="w-1/2 bg-white" style="position: relative;">
                            <div id="editor" contenteditable="true" spellcheck="false" data-grammar-check="true" data-placeholder="Type here to start creating blog..."><%- postContent || '' %></div>
                            <textarea id="xml-view" readonly class="xml-view hidden w-full h-full p-4 text-sm border-none resize-none outline-none leading-relaxed bg-gray-50" style="tab-size: 2; white-space: pre-wrap; word-wrap: break-word; min-height: 400px;" placeholder="XML representation will appear here..."></textarea>
                        </div>
                        <div id="slider"></div>
                        <div id="preview-pane" class="w-1/2 bg-gray-50">
                            <div id="preview-container">

                                <div id="preview-content"></div>
                            </div>
                        </div>
                    </div>

                    <div id="ai-tools-pane" class="w-64 xl:w-72 flex-shrink-0 p-3 lg:p-4 bg-gray-50 border-l border-gray-200" style="position: sticky; top: 80px; height: calc(100vh - 100px); align-self: flex-start;">

                        <div class="ai-tools-section">
                            <div class="ai-tools-header">
                                <h3 >AI Tools</h3>
                            </div>
                            <div class="space-y-2">
                                <button type="button" id="ai-format" class="ai-tool-button-enhanced">
                                    <span class="material-symbols-outlined">auto_fix_high</span>
                                    <span>Auto Format</span>
                                </button>
                                <button type="button" id="ai-assistant-button" class="ai-tool-button-enhanced ai-tool-button-highlight">
                                    <span class="material-symbols-outlined">psychology</span>
                                    <span>AI Writing Assistant</span>
                                </button>
                                <button type="button" id="ai-plagiarism" class="ai-tool-button-enhanced">
                                    <span class="material-symbols-outlined">policy</span>
                                    <span>Check Plagiarism</span>
                                </button>

                                <div id="ai-plagiarism-dropdown" class="ai-tool-dropdown collapsed">
                                    <div class="ai-tool-dropdown-header" onclick="toggleDropdown('plagiarism')">
                                        <div class="ai-tool-dropdown-title">
                                            <span class="material-symbols-outlined">policy</span>
                                            <span>Plagiarism Results</span>
                                        </div>
                                        <span class="material-symbols-outlined ai-tool-dropdown-toggle">expand_more</span>
                                    </div>
                                    <div class="ai-tool-dropdown-content">
                                        <div class="ai-tool-dropdown-actions">
                                            <button type="button" id="plagiarism-check-again" class="check-again-button">
                                                <span class="material-symbols-outlined">refresh</span>
                                                <span>Check Again</span>
                                            </button>
                                        </div>
                                        <div id="ai-plagiarism-result"></div>
                                    </div>
                                </div>
                                
                                <button type="button" id="ai-keywords" class="ai-tool-button-enhanced">
                                    <span class="material-symbols-outlined">tag</span>
                                    <span>Check Keywords</span>
                                </button>
                                <div id="ai-keywords-result" class="mt-2 hidden"></div>
                                
                                <button type="button" id="ai-readability" class="ai-tool-button-enhanced">
                                    <span class="material-symbols-outlined">menu_book</span>
                                    <span>Check Readability</span>
                                </button>

                                <div id="ai-readability-dropdown" class="ai-tool-dropdown collapsed">
                                    <div class="ai-tool-dropdown-header" onclick="toggleDropdown('readability')">
                                        <div class="ai-tool-dropdown-title">
                                            <span class="material-symbols-outlined">menu_book</span>
                                            <span>Readability Results</span>
                                        </div>
                                        <span class="material-symbols-outlined ai-tool-dropdown-toggle">expand_more</span>
                                    </div>
                                    <div class="ai-tool-dropdown-content">
                                        <div class="ai-tool-dropdown-actions">
                                            <button type="button" id="readability-check-again" class="check-again-button">
                                                <span class="material-symbols-outlined">refresh</span>
                                                <span>Check Again</span>
                                            </button>
                                        </div>
                                        <div id="ai-readability-result"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="seo-settings-section">
                            <div class="seo-settings-header">
                                <h4>SEO Settings</h4>
                            </div>
                                <div class="space-y-4">
                                    
                                    <div class="seo-field-compact group">
                                        <label for="seo-focus-keyword-sidebar" class="flex items-center gap-1 text-xs font-semibold text-gray-700 mb-2">
                                            Focus Keyword
                                        </label>
                                        <input type="text" id="seo-focus-keyword-sidebar" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 bg-white shadow-sm hover:shadow-md" placeholder="Enter target keyword">
                                    </div>

                                    <div class="seo-field-compact group">
                                        <label for="seo-meta-description-sidebar" class="flex items-center gap-1 text-xs font-semibold text-gray-700 mb-2">
                                            Meta Description
                                        </label>
                                        <textarea id="seo-meta-description-sidebar" rows="3" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none transition-all duration-200 bg-white shadow-sm hover:shadow-md" placeholder="Write a compelling description for search engines..." maxlength="200"></textarea>
                                        <div class="flex justify-between items-center mt-1">
                                            <small class="text-xs text-gray-600">Recommended: 150-160 characters</small>
                                            <small class="char-count-sidebar text-xs font-semibold text-blue-600">0/160</small>
                                        </div>
                                    </div>

                                    <div class="space-y-3">
                                        <button type="button" id="analyze-seo-sidebar" class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white text-sm font-semibold rounded-lg hover:from-blue-700 hover:to-indigo-700 transform hover:scale-105 transition-all duration-200 shadow-md hover:shadow-lg">
                                            <span class="material-symbols-outlined text-lg">analytics</span>
                                            Analyze SEO Score
                                        </button>
                                        
                                        <button type="button" id="seo-suggestions-sidebar" class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-gradient-to-r from-emerald-50 to-teal-50 text-emerald-700 border border-emerald-200 text-sm font-semibold rounded-lg hover:from-emerald-100 hover:to-teal-100 hover:border-emerald-300 transform hover:scale-105 transition-all duration-200 shadow-sm hover:shadow-md">
                                            <span class="material-symbols-outlined text-lg">auto_awesome</span>
                                            Get AI Suggestions
                                        </button>
                                    </div>

                                    <div id="seo-score-sidebar" class="hidden">
                                        <div class="bg-gradient-to-br from-white via-blue-50 to-indigo-50 p-4 rounded-xl border border-blue-200 shadow-lg">
                                            <div class="flex items-center justify-between mb-3">
                                                <div class="flex items-center gap-2">
                                                    <span class="material-symbols-outlined text-blue-600 bg-blue-100 p-1 rounded-md">trending_up</span>
                                                    <span class="text-sm font-semibold text-gray-700">SEO Score</span>
                                                </div>
                                                <div class="text-right">
                                                    <span id="seo-score-number-sidebar" class="text-2xl font-bold text-blue-600">0</span>
                                                    <span class="text-sm text-gray-600">/100</span>
                                                </div>
                                            </div>
                                            <div class="w-full bg-gray-200 rounded-full h-3 mb-3 overflow-hidden">
                                                <div id="seo-score-bar-sidebar" class="bg-gradient-to-r from-blue-500 to-green-500 h-3 rounded-full transition-all duration-1000 ease-out" style="width: 0%"></div>
                                            </div>
                                            <div class="flex items-center justify-between">
                                                <p id="seo-score-status-sidebar" class="text-sm font-medium text-gray-600">Ready to analyze</p>
                                                <div class="flex gap-1">
                                                    <div class="w-2 h-2 bg-red-400 rounded-full opacity-60"></div>
                                                    <div class="w-2 h-2 bg-yellow-400 rounded-full opacity-60"></div>
                                                    <div class="w-2 h-2 bg-green-400 rounded-full opacity-60"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <div id="errorModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 modal-backdrop hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 modal-content transform transition-all scale-95 hover:scale-100">
            <div class="flex items-center mb-4">
                <div class="flex-shrink-0">
                    <div id="errorIcon" class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center">
                        <span class="material-symbols-outlined text-red-600 text-xl">error</span>
                    </div>
                </div>
                <div class="ml-3">
                    <h3 id="errorTitle" class="text-lg font-medium text-gray-900">Error</h3>
                </div>
            </div>
            <div class="mb-6">
                <p id="errorMessage" class="text-sm text-gray-600 leading-relaxed"></p>
            </div>
            <div class="flex justify-end">
                <button type="button" id="closeErrorModal" class="modal-button px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 transition-all duration-200 font-medium">
                    Close
                </button>
            </div>
        </div>
    </div>

    <div id="advancedSeoModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 modal-backdrop hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg mx-4 modal-content transform transition-all scale-95 hover:scale-100 relative">
            <button type="button" id="closeAdvancedSeo" class="absolute top-3 right-3 p-2 rounded-full text-gray-500 hover:text-gray-700 hover:bg-gray-100 transition-colors" aria-label="Close advanced SEO settings">
                <span class="material-symbols-outlined">close</span>
            </button>
            <div class="mb-4">
                <h2 class="text-xl font-semibold text-gray-900">Advanced SEO Settings</h2>
                <p class="text-sm text-gray-600 mt-1">Configure your URL slug, canonical link, and social share metadata.</p>
            </div>
            <div class="space-y-4">
                <div class="seo-field-compact group">
                    <label for="seo-slug-sidebar" class="flex items-center gap-1 text-xs font-semibold text-gray-700 mb-2">
                        <span class="material-symbols-outlined text-xs">tag</span>
                        URL Slug
                        <span class="text-xs text-gray-400 ml-1">(auto-generated)</span>
                    </label>
                    <input type="text" id="seo-slug-sidebar" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 bg-white shadow-sm hover:shadow-md" placeholder="seo-friendly-url-slug">
                </div>
                <div class="seo-field-compact group">
                    <label for="seo-canonical-sidebar" class="flex items-center gap-1 text-xs font-semibold text-gray-700 mb-2">
                        <span class="material-symbols-outlined text-xs">link</span>
                        Canonical URL
                        <span class="text-xs text-gray-400 ml-1">(optional)</span>
                    </label>
                    <input type="url" id="seo-canonical-sidebar" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 bg-white shadow-sm hover:shadow-md" placeholder="https://example.com/canonical-url">
                    <small class="text-xs text-gray-500 mt-1 block">Specify the preferred URL for search engines.</small>
                </div>
                <div class="seo-field-compact group">
                    <label for="seo-og-title-sidebar" class="flex items-center gap-1 text-xs font-semibold text-gray-700 mb-2">
                        <span class="material-symbols-outlined text-xs">share</span>
                        Social Media Title
                        <span class="text-xs text-gray-400 ml-1">(optional)</span>
                    </label>
                    <input type="text" id="seo-og-title-sidebar" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 bg-white shadow-sm hover:shadow-md" placeholder="Title for social sharing" maxlength="60">
                </div>
                <div class="seo-field-compact group">
                    <label for="seo-og-description-sidebar" class="flex items-center gap-1 text-xs font-semibold text-gray-700 mb-2">
                        <span class="material-symbols-outlined text-xs">description</span>
                        Social Media Description
                        <span class="text-xs text-gray-400 ml-1">(optional)</span>
                    </label>
                    <textarea id="seo-og-description-sidebar" rows="3" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none transition-all duration-200 bg-white shadow-sm hover:shadow-md" placeholder="Description for social media sharing..." maxlength="300"></textarea>
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="cancelAdvancedSeo" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50 transition-all duration-200 font-medium">Cancel</button>
                <button type="button" id="saveAdvancedSeo" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-all duration-200 font-medium">Save Settings</button>
            </div>
        </div>
    </div>

    <div id="successModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 modal-backdrop hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 modal-content transform transition-all scale-95 hover:scale-100">
            <div class="flex items-center mb-4">
                <div class="flex-shrink-0">
                    <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                        <span class="material-symbols-outlined text-green-600 text-xl">check_circle</span>
                    </div>
                </div>
                <div class="ml-3">
                    <h3 id="successTitle" class="text-lg font-medium text-gray-900">Success</h3>
                </div>
            </div>
            <div class="mb-6">
                <p id="successMessage" class="text-sm text-gray-600 leading-relaxed"></p>
            </div>
            <div class="flex justify-end">
                <button type="button" id="closeSuccessModal" class="modal-button px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 transition-all duration-200 font-medium">
                    Close
                </button>
            </div>
        </div>
    </div>

    <div id="aiResultModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg mx-4 transform transition-all scale-95 hover:scale-100">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                        <span class="material-symbols-outlined text-blue-600 text-xl">smart_toy</span>
                    </div>
                    <h3 id="aiModalTitle" class="text-xl font-semibold text-gray-900">AI Tool</h3>
                </div>
                <button type="button" id="closeAiModal" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                    <span class="material-symbols-outlined text-gray-500">close</span>
                </button>
            </div>
            <div id="aiModalContent" class="max-h-[60vh] overflow-y-auto bg-gray-50 rounded-lg p-4"></div>
        </div>
    </div>

    <div id="formatLoadingModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-sm w-full mx-4">
            <div class="text-center">
                
                <div class="relative mb-6">
                    <div class="loading-spinner"></div>
                    <div class="loading-pulse"></div>
                </div>

                <h3 class="text-xl font-semibold text-gray-800 mb-2">Auto Formatting</h3>

                <p class="text-gray-600 mb-4">AI is enhancing your content...</p>

                <div class="w-full bg-gray-200 rounded-full h-1.5 mb-4">
                    <div class="bg-blue-600 h-1.5 rounded-full loading-progress"></div>
                </div>

                <div id="formatStatusText" class="text-sm text-gray-500">
                    <span class="loading-text">Analyzing content structure</span>
                </div>
            </div>
        </div>
    </div>
    
    <div id="linkModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 modal-backdrop hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md mx-4 modal-content transform transition-all scale-95 hover:scale-100">
            <div class="flex items-center mb-4">
                <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                    <span class="material-symbols-outlined text-blue-600 text-xl">link</span>
                </div>
                <h3 class="text-xl font-semibold text-gray-900">Add Link</h3>
            </div>
            <div id="linkTextGroup" class="mb-4">
                <label for="linkText" class="block text-sm font-medium text-gray-700 mb-2">Text to display</label>
                <input id="linkText" type="text" class="form-input w-full border border-gray-300 px-3 py-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200">
            </div>
            <div class="mb-6">
                <label for="linkUrl" class="block text-sm font-medium text-gray-700 mb-2">URL</label>
                <input id="linkUrl" type="text" class="form-input w-full border border-gray-300 px-3 py-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200" placeholder="https://example.com">
            </div>
            <div class="flex justify-end gap-3">
                <button type="button" id="cancelLink" class="modal-button px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50 transition-all duration-200 font-medium">Cancel</button>
                <button type="button" id="applyLink" class="modal-button px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-all duration-200 font-medium">Apply</button>
            </div>
        </div>
    </div>

    <div id="keywordsModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md mx-4 transform transition-all scale-95 hover:scale-100">
            <div class="flex items-center mb-4">
                <div class="w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center mr-3">
                    <span class="material-symbols-outlined text-yellow-600 text-xl">highlight</span>
                </div>
                <h3 class="text-xl font-semibold text-gray-900">Highlight Keywords</h3>
            </div>
            <div class="mb-6">
                <label for="keywordsInput" class="block text-sm font-medium text-gray-700 mb-2">Enter keywords to highlight (comma-separated)</label>
                <textarea id="keywordsInput" rows="4" class="w-full border border-gray-300 px-3 py-2 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-all duration-200 resize-none" placeholder="e.g., technology, innovation, AI"></textarea>
                <p class="text-xs text-gray-500 mt-2">Keywords will be highlighted in the preview area. Clear the field to remove highlighting.</p>
            </div>
            <div class="flex justify-end gap-3">
                <button type="button" id="clearKeywords" class="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 transition-all duration-200 font-medium">Clear All</button>
                <button type="button" id="cancelKeywords" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50 transition-all duration-200 font-medium">Cancel</button>
                <button type="button" id="applyKeywords" class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-opacity-50 transition-all duration-200 font-medium">Highlight</button>
            </div>
        </div>
    </div>
    
    <div id="imageModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg mx-4 transform transition-all scale-95 hover:scale-100">
            <div class="flex items-center mb-4">
                <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mr-3">
                    <span class="material-symbols-outlined text-green-600 text-xl">image</span>
                </div>
                <h3 class="text-xl font-semibold text-gray-900">Add Image</h3>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Image Source (URL or Upload)</label>
                <input id="imageUrl" type="text" class="w-full border border-gray-300 px-3 py-2 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200" placeholder="https://source.unsplash.com/random/400x300">
                <p class="text-center my-3 text-gray-500 font-medium">OR</p>
                <input id="imageUpload" type="file" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100 transition-all duration-200"/>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="imageWidth" class="block text-sm font-medium text-gray-700 mb-2">Width</label>
                    <input id="imageWidth" type="text" placeholder="e.g., 300px or 50%" class="w-full border border-gray-300 px-3 py-2 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200">
                </div>
                <div>
                    <label for="imageHeight" class="block text-sm font-medium text-gray-700 mb-2">Height</label>
                    <input id="imageHeight" type="text" placeholder="e.g., 200px or auto" class="w-full border border-gray-300 px-3 py-2 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200">
                </div>
            </div>
            <div class="mb-6">
                <label for="imageAlign" class="block text-sm font-medium text-gray-700 mb-2">Alignment</label>
                <select id="imageAlign" class="w-full border border-gray-300 px-3 py-2 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200">
                    <option value="none">None (inline)</option>
                    <option value="left">Left</option>
                    <option value="center">Center</option>
                    <option value="right">Right</option>
                </select>
            </div>
                    <option value="right">Right</option>
                </select>
            </div>
            <div class="flex justify-end gap-3">
                <button type="button" id="cancelImage" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50 transition-all duration-200 font-medium">Cancel</button>
                <button type="button" id="applyImage" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 transition-all duration-200 font-medium">Add Image</button>
            </div>
        </div>
    </div>

    <div id="videoModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg mx-4 transform transition-all scale-95 hover:scale-100">
            <div class="flex items-center mb-4">
                <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center mr-3">
                    <span class="material-symbols-outlined text-purple-600 text-xl">videocam</span>
                </div>
                <h3 class="text-xl font-semibold text-gray-900">Add Video</h3>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Video Source (URL or Upload)</label>
                <input id="videoUrl" type="text" class="w-full border border-gray-300 px-3 py-2 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all duration-200" placeholder="https://example.com/video.mp4">
                <p class="text-center my-3 text-gray-500 font-medium">OR</p>
                <input id="videoUpload" type="file" accept="video/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100 transition-all duration-200"/>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="videoWidth" class="block text-sm font-medium text-gray-700 mb-2">Width</label>
                    <input id="videoWidth" type="text" placeholder="e.g., 400px or 100%" class="w-full border border-gray-300 px-3 py-2 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all duration-200">
                </div>
                <div>
                    <label for="videoHeight" class="block text-sm font-medium text-gray-700 mb-2">Height</label>
                    <input id="videoHeight" type="text" placeholder="e.g., 225px or auto" class="w-full border border-gray-300 px-3 py-2 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all duration-200">
                </div>
            </div>
            <div class="mb-6">
                <label for="videoAlign" class="block text-sm font-medium text-gray-700 mb-2">Alignment</label>
                <select id="videoAlign" class="w-full border border-gray-300 px-3 py-2 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all duration-200">
                    <option value="none">None</option>
                    <option value="left">Left</option>
                    <option value="right">Right</option>
                </select>
            </div>
            <div class="flex justify-end gap-3">
                <button type="button" id="cancelVideo" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50 transition-all duration-200 font-medium">Cancel</button>
                <button type="button" id="applyVideo" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50 transition-all duration-200 font-medium">Add Video</button>
            </div>
        </div>
    </div>

    <div id="ai-assistant-modal" class="ai-assistant-modal">
        <div class="ai-assistant-content">
            <div class="ai-assistant-header">
                <div class="ai-assistant-header-info">
                    <h3>AI Writing Assistant</h3>
                    <p>Get help with your content, writing style, and SEO optimization</p>
                </div>
                <button class="ai-assistant-close" id="ai-assistant-close">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="ai-assistant-messages" id="ai-assistant-messages">
                <div class="ai-message">
                    <div class="ai-message-avatar ai">
                        <span class="material-symbols-outlined">psychology</span>
                    </div>
                    <div class="ai-message-content">
                        <p>Hello! I'm your AI Writing Assistant. I can help you with:</p>
                        <ul style="margin: 0.5rem 0; padding-left: 1.25rem;">
                            <li>Improving your writing style and clarity</li>
                            <li>SEO optimization suggestions</li>
                            <li>Content structure and flow</li>
                            <li>Grammar and readability improvements</li>
                        </ul>
                        <p>What would you like help with today?</p>
                    </div>
                </div>
            </div>
            <div class="ai-assistant-input-area">
                <input type="text" class="ai-assistant-input" id="ai-assistant-input" placeholder="Ask me anything about your content..." maxlength="500">
                <button class="ai-assistant-send" id="ai-assistant-send">
                    <span class="material-symbols-outlined">send</span>
                    Send
                </button>
            </div>
        </div>
    </div>

    <div id="seo-score-modal" class="fixed inset-0 bg-gray-800 bg-opacity-20 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-2xl max-h-[85vh] overflow-y-auto border border-gray-200">
            <div class="bg-white text-gray-900 p-5 rounded-t-xl border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-xl font-bold mb-1 flex items-center gap-2 text-gray-900">
                            <span class="material-symbols-outlined text-gray-700">analytics</span>
                            SEO Analysis
                        </h2>
                        <p class="text-gray-500 text-sm">Your content's SEO performance overview</p>
                    </div>
                    <button id="close-seo-modal" class="text-gray-500 hover:text-gray-700 transition-colors p-1 rounded-lg hover:bg-gray-100">
                        <span class="material-symbols-outlined text-2xl">close</span>
                    </button>
                </div>
            </div>
            
            <div class="p-5">
                
                <div class="text-center mb-6">
                    <div class="inline-flex items-center justify-center w-24 h-24 rounded-full border-4 border-blue-500/20 text-blue-700 mb-3 bg-blue-50">
                        <div class="text-center">
                            <div id="modal-seo-score" class="text-2xl font-bold">0</div>
                            <div class="text-xs opacity-90">/ 100</div>
                        </div>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-1">SEO Score</h3>
                    <p id="modal-seo-status" class="text-gray-600 text-sm">Ready to analyze...</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-6">
                    <div class="seo-category-card">
                        <div class="flex items-center justify-between mb-1.5">
                            <span class="text-sm font-medium text-gray-800">Content Quality</span>
                            <span id="content-score" class="text-sm font-bold text-blue-600">0/100</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-1.5">
                            <div id="content-bar" class="bg-gradient-to-r from-blue-500 to-indigo-500 h-1.5 rounded-full transition-all duration-1000" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="seo-category-card">
                        <div class="flex items-center justify-between mb-1.5">
                            <span class="text-sm font-medium text-gray-800">Keywords</span>
                            <span id="keywords-score" class="text-sm font-bold text-blue-600">0/100</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-1.5">
                            <div id="keywords-bar" class="bg-gradient-to-r from-blue-500 to-indigo-500 h-1.5 rounded-full transition-all duration-1000" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="seo-category-card">
                        <div class="flex items-center justify-between mb-1.5">
                            <span class="text-sm font-medium text-gray-800">Meta Information</span>
                            <span id="meta-score" class="text-sm font-bold text-blue-600">0/100</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-1.5">
                            <div id="meta-bar" class="bg-gradient-to-r from-blue-500 to-indigo-500 h-1.5 rounded-full transition-all duration-1000" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="seo-category-card">
                        <div class="flex items-center justify-between mb-1.5">
                            <span class="text-sm font-medium text-gray-800">Readability</span>
                            <span id="readability-score" class="text-sm font-bold text-blue-600">0/100</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-1.5">
                            <div id="readability-bar" class="bg-gradient-to-r from-blue-500 to-indigo-500 h-1.5 rounded-full transition-all duration-1000" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                    <h4 class="text-base font-semibold text-gray-800 mb-3 flex items-center">
                        <span class="material-symbols-outlined text-blue-600 mr-2 text-lg">lightbulb</span>
                        Recommendations
                    </h4>
                    <div id="modal-recommendations" class="space-y-3">
                        <p class="text-gray-600 text-sm">Run SEO analysis to get personalized recommendations for improving your content.</p>
                    </div>
                </div>

                <div class="flex gap-3 justify-end mt-5 pt-4 border-t border-gray-200">
                    <button id="close-seo-modal-btn" class="px-4 py-2.5 text-gray-700 hover:text-gray-900 hover:bg-gray-100 rounded-lg font-medium transition-colors text-sm">
                        Cancel
                    </button>
                    <button id="run-seo-analysis-modal" class="bg-blue-600 text-white px-5 py-2.5 rounded-lg font-semibold hover:bg-blue-700 transition-colors text-sm flex items-center gap-2">
                        <span class="material-symbols-outlined text-lg">analytics</span>
                        Run Analysis
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/editor-core.js"></script>
    <script src="/js/ui-controls.js"></script>
    <script src="/js/ai-tools.js"></script>
    <script src="/js/ai-assistant.js"></script>
    <script src="/js/seo-tools.js"></script>
    <script type="module">
        import { autoInitGrammarChecker } from '/js/grammar-checker.js';
        
        // Wait for DOM to be fully ready
        document.addEventListener('DOMContentLoaded', () => {
            // Small delay to ensure editor is fully initialized
            setTimeout(() => {
                console.log('[Grammar] Initializing grammar checker...');
                
                // Initialize grammar checker on any element with data-grammar-check="true"
                const instances = autoInitGrammarChecker({
                    language: 'en-US',
                    underlineStyle: 'wavy',
                    debounceMs: 800,  // Check 800ms after typing stops
                    minChars: 5,      // Start checking after just 5 characters
                    endpoint: '/api/grammar',
                    apiPath: '/check',
                    enableForContentEditable: true,
                    overlayZIndex: 5,
                    highlightColor: '#ef4444'
                });
                
                console.log('[Grammar] Initialized', instances.length, 'grammar checker instance(s)');
                
                // Manual trigger for initial check
                if (instances.length > 0) {
                    setTimeout(() => {
                        console.log('[Grammar] Triggering initial grammar check...');
                        instances[0].checkNow();
                    }, 2000);
                }
            }, 500);
        });

        document.addEventListener('DOMContentLoaded', () => {
            const advancedSeoButton = document.getElementById('advancedSeoButton');
            const advancedSeoModal = document.getElementById('advancedSeoModal');
            const saveAdvancedSeo = document.getElementById('saveAdvancedSeo');
            const cancelAdvancedSeo = document.getElementById('cancelAdvancedSeo');
            const closeAdvancedSeo = document.getElementById('closeAdvancedSeo');
            const slugInput = document.getElementById('seo-slug-sidebar');
            const canonicalInput = document.getElementById('seo-canonical-sidebar');
            const ogTitleInput = document.getElementById('seo-og-title-sidebar');
            const ogDescriptionInput = document.getElementById('seo-og-description-sidebar');
            const trackedInputs = [slugInput, canonicalInput, ogTitleInput, ogDescriptionInput].filter(Boolean);
            let advancedSeoSnapshot = null;

            if (!advancedSeoModal || !advancedSeoButton) {
                syncAdvancedSeoHiddenFields();
                return;
            }

            const captureSnapshot = () => ({
                slug: slugInput ? slugInput.value : '',
                canonical: canonicalInput ? canonicalInput.value : '',
                ogTitle: ogTitleInput ? ogTitleInput.value : '',
                ogDescription: ogDescriptionInput ? ogDescriptionInput.value : ''
            });

            const restoreSnapshot = (snapshot) => {
                if (!snapshot) return;
                if (slugInput) slugInput.value = snapshot.slug || '';
                if (canonicalInput) canonicalInput.value = snapshot.canonical || '';
                if (ogTitleInput) ogTitleInput.value = snapshot.ogTitle || '';
                if (ogDescriptionInput) ogDescriptionInput.value = snapshot.ogDescription || '';
            };

            const openModal = () => {
                advancedSeoSnapshot = captureSnapshot();
                advancedSeoModal.classList.remove('hidden');
                advancedSeoModal.classList.add('flex');
                setTimeout(() => {
                    if (slugInput) slugInput.focus();
                }, 50);
            };

            const closeModal = (restore = false) => {
                if (restore) {
                    restoreSnapshot(advancedSeoSnapshot);
                    syncAdvancedSeoHiddenFields();
                }
                advancedSeoModal.classList.add('hidden');
                advancedSeoModal.classList.remove('flex');
                advancedSeoSnapshot = null;
            };

            advancedSeoButton.addEventListener('click', () => {
                syncAdvancedSeoHiddenFields();
                openModal();
            });

            if (saveAdvancedSeo) {
                saveAdvancedSeo.addEventListener('click', () => {
                    syncAdvancedSeoHiddenFields();
                    closeModal(false);
                });
            }

            [cancelAdvancedSeo, closeAdvancedSeo].forEach(btn => {
                if (btn) {
                    btn.addEventListener('click', () => closeModal(true));
                }
            });

            advancedSeoModal.addEventListener('click', (event) => {
                if (event.target === advancedSeoModal) {
                    closeModal(true);
                }
            });

            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && !advancedSeoModal.classList.contains('hidden')) {
                    closeModal(true);
                }
            });

            trackedInputs.forEach(input => input.addEventListener('input', syncAdvancedSeoHiddenFields));

            syncAdvancedSeoHiddenFields();
        });
    </script>

    <script>
        // SEO Score Modal Functions - Make globally available
        window.showSEOModal = function() {
            const modal = document.getElementById('seo-score-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            // Animate modal entrance
            setTimeout(() => {
                const modalContent = modal.querySelector('div');
                modalContent.style.transform = 'scale(1)';
                modalContent.style.opacity = '1';
            }, 10);
        }
        
        function closeSEOModal() {
            const modal = document.getElementById('seo-score-modal');
            const modalContent = modal.querySelector('div');
            
            // Animate modal exit
            modalContent.style.transform = 'scale(0.95)';
            modalContent.style.opacity = '0';
            
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                modalContent.style.transform = 'scale(1)';
                modalContent.style.opacity = '1';
            }, 200);
        }
        
        window.updateSEOModalData = function(seoData) {
            console.log('Updating SEO Modal with data:', seoData); // Debug log
            
            // Update overall score
            const scoreElement = document.getElementById('modal-seo-score');
            const statusElement = document.getElementById('modal-seo-status');
            
            if (seoData && seoData.overallScore !== undefined) {
                scoreElement.textContent = Math.round(seoData.overallScore);
                
                let status = 'Needs Improvement';
                if (seoData.overallScore >= 80) status = 'Excellent';
                else if (seoData.overallScore >= 60) status = 'Good';
                else if (seoData.overallScore >= 40) status = 'Fair';
                
                statusElement.textContent = status;
                
                // Handle category scores - check both direct scores and nested categoryScores
                const categoryScores = seoData.categoryScores || seoData;
                updateCategoryScore('content', categoryScores.content?.score || categoryScores.contentScore || 0);
                updateCategoryScore('keywords', categoryScores.keyword?.score || categoryScores.keywordScore || 0);
                updateCategoryScore('meta', categoryScores.meta?.score || categoryScores.metaScore || 0);
                updateCategoryScore('readability', categoryScores.readability?.score || categoryScores.readabilityScore || 0);
                
                // Update recommendations
                console.log('Recommendations data:', seoData.recommendations); // Debug log
                updateRecommendations(seoData.recommendations || []);
            } else {
                console.warn('No valid SEO data received:', seoData);
            }
        }
        
        function updateCategoryScore(category, score) {
            const scoreElement = document.getElementById(`${category}-score`);
            const barElement = document.getElementById(`${category}-bar`);
            
            if (scoreElement && barElement) {
                scoreElement.textContent = `${Math.round(score)}/100`;
                
                // Animate progress bar
                setTimeout(() => {
                    barElement.style.width = `${Math.min(100, Math.max(0, score))}%`;
                }, 300);
            }
        }
        
        function updateRecommendations(recommendations) {
            const container = document.getElementById('modal-recommendations');
            
            if (recommendations.length === 0) {
                container.innerHTML = '<p class="text-gray-600">Great job! Your content meets all SEO best practices.</p>';
                return;
            }
            
            const recommendationsHTML = recommendations.map((rec, index) => {
                console.log('Processing recommendation:', rec, typeof rec); // Debug log
                
                let title, description, cardClass, iconClass, textClass;
                
                if (typeof rec === 'string') {
                    title = `Recommendation ${index + 1}`;
                    description = rec;
                    cardClass = 'bg-gradient-to-r from-blue-50 to-blue-100 border-l-4 border-blue-400';
                    iconClass = 'lightbulb';
                    textClass = 'text-blue-600';
                } else if (rec && typeof rec === 'object') {
                    // Handle SEO generator format: {category, priority, issues}
                    if (rec.category && rec.issues) {
                        title = `${rec.category} Issues`;
                        description = Array.isArray(rec.issues) 
                            ? rec.issues.join('. ') + '.'
                            : String(rec.issues);
                        
                        // Set priority-based styling
                        if (rec.priority === 'high') {
                            cardClass = 'bg-gradient-to-r from-red-50 to-red-100 border-l-4 border-red-400';
                            iconClass = 'warning';
                            textClass = 'text-red-600';
                        } else if (rec.priority === 'medium') {
                            cardClass = 'bg-gradient-to-r from-orange-50 to-orange-100 border-l-4 border-orange-400';
                            iconClass = 'info';
                            textClass = 'text-orange-600';
                        } else {
                            cardClass = 'bg-gradient-to-r from-yellow-50 to-yellow-100 border-l-4 border-yellow-400';
                            iconClass = 'lightbulb';
                            textClass = 'text-yellow-600';
                        }
                    }
                    // Handle custom format: {title, description}
                    else {
                        title = rec.title || rec.message || `Recommendation ${index + 1}`;
                        description = rec.description || rec.text || rec.message || 'No description available';
                        cardClass = 'bg-gradient-to-r from-blue-50 to-blue-100 border-l-4 border-blue-400';
                        iconClass = 'lightbulb';
                        textClass = 'text-blue-600';
                    }
                } else {
                    title = `Recommendation ${index + 1}`;
                    description = String(rec || 'No description available');
                    cardClass = 'bg-gradient-to-r from-gray-50 to-gray-100 border-l-4 border-gray-400';
                    iconClass = 'help';
                    textClass = 'text-gray-600';
                }
                
                return `
                    <div class="flex items-start space-x-3 p-3 ${cardClass} rounded-lg shadow-sm hover:shadow-md transition-all duration-200">
                        <span class="material-symbols-outlined ${textClass} mt-0.5 text-lg">${iconClass}</span>
                        <div class="flex-1">
                            <h5 class="font-semibold text-gray-800 mb-1 text-sm">${title}</h5>
                            <p class="text-gray-700 text-xs leading-relaxed">${description}</p>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = recommendationsHTML;
        }
        
        // Event listeners for SEO modal
        document.addEventListener('DOMContentLoaded', () => {
            // Close modal events
            const closeButtons = document.querySelectorAll('#close-seo-modal, #close-seo-modal-btn');
            closeButtons.forEach(btn => {
                btn.addEventListener('click', closeSEOModal);
            });
            
            // Close on backdrop click
            document.getElementById('seo-score-modal').addEventListener('click', (e) => {
                if (e.target.id === 'seo-score-modal') {
                    closeSEOModal();
                }
            });
            
            // Run SEO analysis from modal
            document.getElementById('run-seo-analysis-modal').addEventListener('click', async () => {
                try {
                    // Get content and SEO data
                    const title = document.getElementById('blogTitle')?.value || '';
                    const content = document.getElementById('editor')?.innerHTML || '';
                    const metaDesc = document.getElementById('seo-meta-description-sidebar')?.value || '';
                    const focusKeyword = document.getElementById('seo-focus-keyword-sidebar')?.value || '';
                    const urlSlug = document.getElementById('seo-slug-sidebar')?.value || '';
                    
                    // Run SEO analysis
                    const response = await fetch('/api/seo/analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            title,
                            content,
                            metaDescription: metaDesc,
                            focusKeyword,
                            slug: urlSlug
                        })
                    });
                    
                    const seoResult = await response.json();
                    
                    if (seoResult.success && seoResult.data) {
                        // Extract the actual SEO score data
                        const seoData = seoResult.data.seoScore || seoResult.data;
                        
                        // Update modal with results
                        updateSEOModalData(seoData);
                        
                        // Update mini score display
                        const miniScore = document.getElementById('mini-seo-score');
                        if (miniScore && seoData.overallScore !== undefined) {
                            miniScore.textContent = `SEO: ${Math.round(seoData.overallScore)}`;
                            miniScore.classList.remove('hidden');
                        }
                        
                        // Store SEO data
                        document.getElementById('seoData').value = JSON.stringify(seoData);
                    }
                } catch (error) {
                    console.error('SEO Analysis error:', error);
                    alert('Failed to run SEO analysis. Please try again.');
                }
            });
            
            // Keyword highlighting functionality
            const keywordHighlightState = {
                originalContent: '',
                isHighlighted: false,
                currentKeywords: []
            };
            
            // Keywords modal handlers
            document.getElementById('applyKeywords').addEventListener('click', () => {
                const keywordsInput = document.getElementById('keywordsInput');
                const keywords = keywordsInput.value
                    .split(',')
                    .map(k => k.trim())
                    .filter(k => k.length > 0);
                
                if (keywords.length > 0) {
                    highlightKeywordsInPreview(keywords);
                    document.getElementById('keywordsModal').classList.add('hidden');
                    document.getElementById('keywordsModal').classList.remove('flex');
                }
            });
            
            document.getElementById('clearKeywords').addEventListener('click', () => {
                clearKeywordHighlights();
                document.getElementById('keywordsInput').value = '';
                document.getElementById('keywordsModal').classList.add('hidden');
                document.getElementById('keywordsModal').classList.remove('flex');
            });
            
            document.getElementById('cancelKeywords').addEventListener('click', () => {
                document.getElementById('keywordsModal').classList.add('hidden');
                document.getElementById('keywordsModal').classList.remove('flex');
            });
        });
        
        function highlightKeywordsInPreview(keywords) {
            const previewArea = document.getElementById('previewContent');
            if (!previewArea) return;
            
            // Store original content if not already stored
            if (!keywordHighlightState.isHighlighted) {
                keywordHighlightState.originalContent = previewArea.innerHTML;
            }
            
            let content = keywordHighlightState.originalContent;
            keywordHighlightState.currentKeywords = keywords;
            
            // Create regex pattern for all keywords
            const escapedKeywords = keywords.map(keyword => 
                keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')
            );
            const pattern = new RegExp(`\\b(${escapedKeywords.join('|')})\\b`, 'gi');
            
            // Replace keywords with highlighted versions
            content = content.replace(pattern, '<span class="keyword-highlight">$1</span>');
            
            previewArea.innerHTML = content;
            keywordHighlightState.isHighlighted = true;
            
            // Add visual feedback
            setTimeout(() => {
                const highlights = previewArea.querySelectorAll('.keyword-highlight');
                highlights.forEach((highlight, index) => {
                    setTimeout(() => {
                        highlight.style.animation = 'none';
                        highlight.offsetHeight; // Trigger reflow
                        highlight.style.animation = 'highlight-pulse 0.6s ease-out';
                    }, index * 100);
                });
            }, 100);
        }
        
        function clearKeywordHighlights() {
            const previewArea = document.getElementById('previewContent');
            if (!previewArea || !keywordHighlightState.isHighlighted) return;
            
            // Restore original content
            previewArea.innerHTML = keywordHighlightState.originalContent;
            keywordHighlightState.isHighlighted = false;
            keywordHighlightState.currentKeywords = [];
        }
        
        // Auto-update highlighting when content changes
        function updateKeywordHighlights() {
            if (keywordHighlightState.isHighlighted && keywordHighlightState.currentKeywords.length > 0) {
                // Update original content and re-apply highlighting
                const previewArea = document.getElementById('previewContent');
                if (previewArea) {
                    // Get current content without highlights
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = previewArea.innerHTML;
                    const highlights = tempDiv.querySelectorAll('.keyword-highlight');
                    highlights.forEach(highlight => {
                        highlight.outerHTML = highlight.textContent;
                    });
                    keywordHighlightState.originalContent = tempDiv.innerHTML;
                    
                    // Re-apply highlighting
                    highlightKeywordsInPreview(keywordHighlightState.currentKeywords);
                }
            }
        }
        
        // XML Formatting and Toggle Functions
        function formatXMLContent(content) {
            try {
                console.log(' [XML] Starting formatXMLContent with content:', content?.substring(0, 100) + '...');
                
                // Don't process empty content
                if (!content || content.trim() === '' || content === '<p><br></p>' || content === '<br>') {
                    console.log(' [XML] Empty content detected, returning default XML');
                    return '<?xml version="1.0" encoding="UTF-8"?>\n<document>\n  <metadata/>\n  <content/>\n</document>';
                }

                // Clean HTML tags and get plain text more carefully
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = content;
                
                // Remove any script tags or unwanted elements
                const scripts = tempDiv.querySelectorAll('script, style');
                scripts.forEach(el => el.remove());
                
                const plainText = tempDiv.textContent || tempDiv.innerText || '';
                console.log(' [XML] Extracted plain text:', plainText?.substring(0, 100) + '...');
                
                // Split into lines and filter empty ones, also remove duplicates
                const lines = plainText.split('\n')
                    .map(line => line.trim())
                    .filter(line => line && line.length > 0);
                
                // Remove duplicate consecutive lines
                const uniqueLines = [];
                let lastLine = '';
                lines.forEach(line => {
                    if (line !== lastLine) {
                        uniqueLines.push(line);
                        lastLine = line;
                    }
                });
                
                console.log(' [XML] Unique lines found:', uniqueLines.length);
                
                let xmlOutput = '<?xml version="1.0" encoding="UTF-8"?>\n';
                xmlOutput += '<document>\n';
                xmlOutput += '  <metadata>\n';
                
                // Get metadata from form fields
                const titleElement = document.getElementById('blogTitle');
                const actualTitle = titleElement ? titleElement.value.trim() : '';
                if (actualTitle && actualTitle !== 'Untitled Draft') {
                    xmlOutput += `    <title>${escapeXml(actualTitle)}</title>\n`;
                }
                
                const metaDescElement = document.getElementById('seo-meta-description-sidebar');
                const metaDesc = metaDescElement ? metaDescElement.value.trim() : '';
                if (metaDesc) {
                    xmlOutput += `    <description>${escapeXml(metaDesc)}</description>\n`;
                }
                
                const focusKeywordElement = document.getElementById('seo-focus-keyword-sidebar');
                const focusKeyword = focusKeywordElement ? focusKeywordElement.value.trim() : '';
                if (focusKeyword) {
                    xmlOutput += `    <keywords>${escapeXml(focusKeyword)}</keywords>\n`;
                }
                
                xmlOutput += '  </metadata>\n';
                xmlOutput += '  <content>\n';
                
                // Process content into structured elements with better logic
                let elementCount = 1;
                uniqueLines.forEach(line => {
                    const trimmed = line.trim();
                    if (trimmed && trimmed.length > 0) {
                        // Better logic for determining element type
                        if (trimmed.length <= 60 && !trimmed.includes('.') && !trimmed.includes(',')) {
                            // Likely a heading
                            xmlOutput += `    <heading id="h${elementCount}" level="2">\n`;
                            xmlOutput += `      ${escapeXml(trimmed)}\n`;
                            xmlOutput += `    </heading>\n`;
                        } else {
                            // Likely a paragraph
                            xmlOutput += `    <paragraph id="p${elementCount}" type="main">\n`;
                            xmlOutput += `      ${escapeXml(trimmed)}\n`;
                            xmlOutput += `    </paragraph>\n`;
                        }
                        elementCount++;
                    }
                });
                
                xmlOutput += '  </content>\n';
                xmlOutput += '</document>';
                
                console.log(' [XML] Generated XML with', elementCount - 1, 'elements');
                return xmlOutput;
            } catch (error) {
                console.error(' [XML] Formatting error:', error);
                return '<?xml version="1.0" encoding="UTF-8"?>\n<document>\n  <metadata/>\n  <content>\n    <error>XML formatting failed</error>\n  </content>\n</document>';
            }
        }
        
        function escapeXml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&apos;');
        }

        function syncAdvancedSeoHiddenFields() {
            const slugInput = document.getElementById('seo-slug-sidebar');
            const canonicalInput = document.getElementById('seo-canonical-sidebar');
            const ogTitleInput = document.getElementById('seo-og-title-sidebar');
            const ogDescriptionInput = document.getElementById('seo-og-description-sidebar');

            const slugHidden = document.getElementById('urlSlugInput');
            const canonicalHidden = document.getElementById('canonicalUrlInput');
            const ogTitleHidden = document.getElementById('ogTitleInput');
            const ogDescriptionHidden = document.getElementById('ogDescriptionInput');

            if (slugHidden && slugInput) slugHidden.value = slugInput.value.trim();
            if (canonicalHidden && canonicalInput) canonicalHidden.value = canonicalInput.value.trim();
            if (ogTitleHidden && ogTitleInput) ogTitleHidden.value = ogTitleInput.value.trim();
            if (ogDescriptionHidden && ogDescriptionInput) ogDescriptionHidden.value = ogDescriptionInput.value.trim();
        }
        window.syncAdvancedSeoHiddenFields = syncAdvancedSeoHiddenFields;
        
        // Initialize XML toggle functionality
        document.addEventListener('DOMContentLoaded', () => {
            const xmlToggle = document.getElementById('xml-toggle');
            const xmlView = document.getElementById('xml-view');
            const editor = document.getElementById('editor');
            const xmlHandle = document.getElementById('xml-toggle-handle');
            
            let isXMLView = false;
            let editorContentSnapshot = '';
            
            if (xmlToggle) {
                xmlToggle.addEventListener('click', () => {
                    isXMLView = !isXMLView;
                    
                    if (isXMLView) {
                        editorContentSnapshot = editor.innerHTML;
                        // Show XML view
                        editor.classList.add('hidden');
                        xmlView.classList.remove('hidden');
                        xmlToggle.classList.remove('bg-gray-200');
                        xmlToggle.classList.add('bg-blue-600');
                        xmlHandle.classList.remove('translate-x-1');
                        xmlHandle.classList.add('translate-x-6');
                        
                        // Format and display XML content - only once per toggle
                        console.log(' [XML] Switching to XML view, generating fresh XML...');
                        const formattedXML = formatXMLContent(editor.innerHTML);
                        xmlView.value = formattedXML;
                        
                        // Auto-resize
                        xmlView.style.height = 'auto';
                        xmlView.style.height = Math.max(400, xmlView.scrollHeight) + 'px';
                        
                    } else {
                        // Show normal editor
                        console.log(' [XML] Switching back to editor view');
                        editor.classList.remove('hidden');
                        xmlView.classList.add('hidden');
                        xmlToggle.classList.add('bg-gray-200');
                        xmlToggle.classList.remove('bg-blue-600');
                        xmlHandle.classList.add('translate-x-1');
                        xmlHandle.classList.remove('translate-x-6');
                        
                        if (editorContentSnapshot && editor.innerHTML !== editorContentSnapshot) {
                            editor.innerHTML = editorContentSnapshot;
                        }
                        editorContentSnapshot = '';

                        window.editorUtils?.updatePreview?.();
                        editor.focus();
                    }
                });
                
                // Removed the MutationObserver that was causing content duplication
                // XML view is now a snapshot taken at toggle time only
                // Removed the MutationObserver that was causing content duplication
                // XML view is now a snapshot taken at toggle time only
            }
        });
        
        // Auto-populate SEO Settings meta description with blog title
        document.addEventListener('DOMContentLoaded', () => {
            const titleInput = document.getElementById('blogTitle');
            const seoMetaDescSidebarField = document.getElementById('seo-meta-description-sidebar');
            
            if (titleInput && seoMetaDescSidebarField) {
                // Set initial meta description if empty and title exists
                const setSEOMetaDescriptionFromTitle = () => {
                    const title = titleInput.value.trim();
                    
                    // Only auto-fill if SEO meta description is empty and title is not empty
                    if (title && !seoMetaDescSidebarField.value.trim()) {
                        const metaDescription = title.length > 155 
                            ? title.substring(0, 152) + '...'
                            : title;
                            
                        seoMetaDescSidebarField.value = metaDescription;
                        
                        // Show visual feedback
                        seoMetaDescSidebarField.style.backgroundColor = '#f0f9ff';
                        seoMetaDescSidebarField.style.borderColor = '#3b82f6';
                        
                        // Update character count
                        const charCount = seoMetaDescSidebarField.closest('.seo-field-compact')?.querySelector('.char-count-sidebar');
                        if (charCount) {
                            charCount.textContent = `${metaDescription.length}/160`;
                        }
                        
                        setTimeout(() => {
                            seoMetaDescSidebarField.style.backgroundColor = '';
                            seoMetaDescSidebarField.style.borderColor = '';
                        }, 1500);
                    }
                };
                
                // Set initial meta description on page load if title exists
                setSEOMetaDescriptionFromTitle();
                
                // Auto-update SEO meta description when title changes (only if meta description is empty)
                titleInput.addEventListener('input', (e) => {
                    const title = e.target.value.trim();
                    
                    // Only auto-update if SEO meta description is currently empty or was auto-generated
                    if (!seoMetaDescSidebarField.value.trim() || seoMetaDescSidebarField.dataset.autoGenerated === 'true') {
                        if (title) {
                            const metaDescription = title.length > 155 
                                ? title.substring(0, 152) + '...'
                                : title;
                                
                            seoMetaDescSidebarField.value = metaDescription;
                            seoMetaDescSidebarField.dataset.autoGenerated = 'true';
                            
                            // Update character count
                            const charCount = seoMetaDescSidebarField.closest('.seo-field-compact')?.querySelector('.char-count-sidebar');
                            if (charCount) {
                                charCount.textContent = `${metaDescription.length}/160`;
                            }
                        } else {
                            seoMetaDescSidebarField.value = '';
                            seoMetaDescSidebarField.dataset.autoGenerated = 'false';
                            
                            // Update character count
                            const charCount = seoMetaDescSidebarField.closest('.seo-field-compact')?.querySelector('.char-count-sidebar');
                            if (charCount) {
                                charCount.textContent = '0/160';
                            }
                        }
                    }
                });
                
                // Mark SEO meta description as manually edited when user types in it
                seoMetaDescSidebarField.addEventListener('input', () => {
                    seoMetaDescSidebarField.dataset.autoGenerated = 'false';
                    
                    // Update character count
                    const charCount = seoMetaDescSidebarField.closest('.seo-field-compact')?.querySelector('.char-count-sidebar');
                    if (charCount) {
                        charCount.textContent = `${seoMetaDescSidebarField.value.length}/160`;
                    }
                });
            }
        });

        // Upload image file to server with animation
        async function uploadImageFile(file, callback) {
            const formData = new FormData();
            formData.append('image', file);

            // Show upload animation
            showImageUploadAnimation();

            try {
                const response = await fetch('/api/upload-image', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    // Hide upload animation
                    hideImageUploadAnimation();
                    // Call callback with the image URL
                    callback(result.url);
                    console.log('Image uploaded successfully:', result.url);
                } else {
                    hideImageUploadAnimation();
                    showErrorModal('Upload Failed', result.error || 'Image upload failed. Please try again.');
                }
            } catch (error) {
                hideImageUploadAnimation();
                console.error('Upload error:', error);
                showErrorModal('Upload Error', 'Image upload failed: ' + error.message);
            }
        }

        function showImageUploadAnimation() {
            // Create upload overlay if it doesn't exist
            let overlay = document.getElementById('upload-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'upload-overlay';
                overlay.innerHTML = `
                    <div class="upload-spinner-container">
                        <div class="upload-spinner"></div>
                        <p class="upload-text">Uploading image...</p>
                    </div>
                `;
                document.body.appendChild(overlay);
            }
            overlay.style.display = 'flex';
        }

        function hideImageUploadAnimation() {
            const overlay = document.getElementById('upload-overlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Title validation for publish button
            const publishButton = document.getElementById('publishButton');
            const titleInput = document.getElementById('blogTitle');
            
            publishButton.addEventListener('click', async (e) => {
                const title = titleInput.value.trim();
                if (!title || title === 'Untitled Draft') {
                    e.preventDefault();
                    showErrorModal('Title Required', 'Please enter a proper title for your blog post before publishing.');
                    titleInput.focus();
                    titleInput.style.borderColor = '#ef4444';
                    titleInput.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.1)';
                    
                    titleInput.addEventListener('input', () => {
                        titleInput.style.borderColor = '';
                        titleInput.style.boxShadow = '';
                    }, { once: true });
                    
                    return false;
                }

                // Check if there's any content
                const editorContent = document.getElementById('editor').innerHTML.trim();
                if (!editorContent || editorContent === '<p><br></p>' || editorContent === '<br>') {
                    e.preventDefault();
                    showErrorModal('Content Required', 'Please add some content to your blog post before publishing.');
                    document.getElementById('editor').focus();
                    return false;
                }
            });

            // Form submit handler to populate SEO data
            document.getElementById('post-form').addEventListener('submit', (e) => {
                // Populate content field
                const postContent = window.editorUtils?.cleanContent(document.getElementById('editor').innerHTML) || '';
                document.getElementById('postContent').value = postContent;

                const metaDesc = document.getElementById('seo-meta-description-sidebar')?.value || '';
                const focusKeyword = document.getElementById('seo-focus-keyword-sidebar')?.value || '';

                document.getElementById('metaDescriptionInput').value = metaDesc;
                document.getElementById('focusKeywordInput').value = focusKeyword;

                syncAdvancedSeoHiddenFields();

                // Populate SEO analysis data if available
                if (window.seoTools) {
                    const seoResult = seoTools.getAnalysisResult();
                    if (seoResult) {
                        document.getElementById('seoData').value = JSON.stringify(seoResult);
                    }
                }
            });

            document.getElementById('saveDraftButton').addEventListener('click', async (e) => {
                e.preventDefault();
                
                const btn = e.currentTarget;
                if (btn.disabled) {
                    console.warn('Save already in progress, ignoring click');
                    return;
                }
                
                btn.disabled = true;
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<span>Saving...</span>';
                
                const postId = document.getElementById('postId').value;
                const postTitle = document.getElementById('blogTitle').value || 'Untitled Draft';
                
                console.log(' [SAVE DRAFT] Starting save for postId:', postId);
                
                // Use strong cleaner to strip Tailwind classes/styles before saving
                const rawHtml = document.getElementById('editor').innerHTML;
                const cleanedForStorage = (window.editorUtils && typeof window.editorUtils.cleanContentForStorage === 'function')
                  ? window.editorUtils.cleanContentForStorage((window.editorUtils.cleanContent || ((h)=>h))(rawHtml))
                  : rawHtml;

                // Generate compact raw XML from cleaned HTML (same whitelist as autosave/submit)
                const postXml = (function toRawXml(html) {
                    try {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(`<div>${html}</div>`, 'text/html');
                        const root = doc.body.firstChild;
                        const ALLOWED_ATTRS = {
                            a: new Set(['href','title','target','rel']),
                            img: new Set(['src','alt','title','width','height']),
                            table: new Set([]), thead: new Set([]), tbody: new Set([]), tfoot: new Set([]),
                            tr: new Set([]), th: new Set(['colspan','rowspan','scope']), td: new Set(['colspan','rowspan']),
                            ul: new Set([]), ol: new Set([]), li: new Set([]),
                            p: new Set(['id']),
                            h1: new Set(['id']), h2: new Set(['id']), h3: new Set(['id']), h4: new Set(['id']), h5: new Set(['id']), h6: new Set(['id']),
                            strong: new Set([]), b: new Set([]), em: new Set([]), i: new Set([]), u: new Set([]), s: new Set([]),
                            blockquote: new Set(['cite']), code: new Set([]), pre: new Set([]), br: new Set([]),
                        };
                        function esc(t){return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&apos;');}
                        function nodeToXml(node){
                            if (node.nodeType === 3) { const txt = node.textContent; return txt && txt.trim() ? esc(txt) : ''; }
                            if (node.nodeType !== 1) return '';
                            const tag = node.tagName.toLowerCase();
                            const allowed = ALLOWED_ATTRS[tag] || new Set();
                            const attrs = Array.from(node.attributes)
                                .filter(a => allowed.has(a.name.toLowerCase()))
                                .map(a => `${a.name}="${esc(a.value)}"`).join(' ');
                            const children = Array.from(node.childNodes).map(nodeToXml).join('');
                            return attrs ? `<${tag} ${attrs}>${children}</${tag}>` : `<${tag}>${children}</${tag}>`;
                        }
                        const xmlInner = Array.from(root.childNodes).map(nodeToXml).join('');
                        return `<document>${xmlInner}</document>`;
                    } catch(e) { console.warn('toRawXml failed:', e); return '<document/>'; }
                })(cleanedForStorage);

                if (!postId) {
                    showErrorModal('Save Error', 'Cannot save draft: No post ID found. Please refresh the page and try again.');
                    btn.disabled = false;
                    btn.innerHTML = originalHTML;
                    return;
                }

                try {
                    console.log(' [SAVE DRAFT] Sending fetch to /api/posts/save/' + postId);
                    const response = await fetch(`/api/posts/save/${postId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            postTitle: postTitle,
                            postContent: cleanedForStorage,
                            postXml: postXml,
                            metaDescription: document.getElementById('seo-meta-description-sidebar')?.value || '',
                            focusKeyword: document.getElementById('seo-focus-keyword-sidebar')?.value || '',
                            urlSlug: document.getElementById('seo-slug-sidebar')?.value || '',
                            canonicalUrl: document.getElementById('seo-canonical-sidebar')?.value || '',
                            ogTitle: document.getElementById('seo-og-title-sidebar')?.value || '',
                            ogDescription: document.getElementById('seo-og-description-sidebar')?.value || ''
                        }),
                    });

                    if (response.ok) {
                        const result = await response.json();
                        console.log(' [SAVE DRAFT] Server returned:', result);
                        
                        // Show success message
                        showSuccessModal('Draft Saved', result.message || 'Your draft has been saved successfully!');
                        
                        // Ensure both hidden postId fields are in sync
                        if (result.postId) {
                            console.log(' [SAVE DRAFT] Updating client postId from', postId, 'to', result.postId);
                            const outer = document.getElementById('postId');
                            const inner = document.getElementById('postIdField');
                            if (outer) outer.value = result.postId;
                            if (inner) inner.value = result.postId;
                            if (history && history.replaceState) {
                                history.replaceState(null, '', `/?postId=${result.postId}`);
                            }
                        }
                        
                        btn.disabled = false;
                        btn.innerHTML = originalHTML;
                        console.log(' [SAVE DRAFT] Complete');
                    } else {
                        // Handle different HTTP error status codes
                        let errorMessage = 'Failed to save draft due to a server error.';
                        
                        try {
                            const errorResponse = await response.json();
                            errorMessage = errorResponse.message || errorMessage;
                        } catch (e) {
                            // If we can't parse the error response, use status-based messages
                            switch (response.status) {
                                case 400:
                                    errorMessage = 'Invalid data provided. Please check your content and try again.';
                                    break;
                                case 401:
                                    errorMessage = 'You are not authorized to save this draft. Please log in and try again.';
                                    break;
                                case 403:
                                    errorMessage = 'You do not have permission to save this draft.';
                                    break;
                                case 404:
                                    errorMessage = 'Draft not found. Please refresh the page and try again.';
                                    break;
                                case 500:
                                    errorMessage = 'Server error occurred. Please try again in a few moments.';
                                    break;
                                default:
                                    errorMessage = `Server returned error ${response.status}. Please try again.`;
                            }
                        }
                        
                        showErrorModal('Save Failed', errorMessage);
                        btn.disabled = false;
                        btn.innerHTML = originalHTML;
                    }
                } catch (error) {
                    console.error(' [SAVE DRAFT] Failed:', error);
                    
                    let errorMessage = 'Failed to save draft. Please check your connection and try again.';
                    
                    // Handle specific error types
                    if (error.name === 'TypeError' && error.message.includes('fetch')) {
                        errorMessage = 'Network error: Unable to connect to the server. Please check your internet connection.';
                    } else if (error.name === 'AbortError') {
                        errorMessage = 'Save operation was cancelled. Please try again.';
                    } else if (error.message) {
                        errorMessage = error.message;
                    }
                    
                    showErrorModal('Network Error', errorMessage);
                    btn.disabled = false;
                    btn.innerHTML = originalHTML;
                }
            });

            // Image Modal functionality
            document.getElementById('insertImage').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('imageModal').style.display = 'flex';
            });

            document.getElementById('cancelImage').addEventListener('click', () => document.getElementById('imageModal').style.display = 'none');

            document.getElementById('applyImage').addEventListener('click', () => {
                const urlInput = document.getElementById('imageUrl');
                const fileInput = document.getElementById('imageUpload');
                const editor = document.getElementById('editor');

                const applyImageToEditor = (src) => {
                    let width = document.getElementById('imageWidth').value.trim();
                    let height = document.getElementById('imageHeight').value.trim();
                    const align = document.getElementById('imageAlign').value;

                    if (width && /^\d+$/.test(width)) width += 'px';
                    if (height && /^\d+$/.test(height)) height += 'px';

                    let style = `max-width: 100%;`;
                    if (width) style += ` width: ${width};`;
                    if (height) style += ` height: ${height};`;
                    else if (width) style += ' height: auto;';

                    const imageId = 'img_' + Date.now();
                    let alignmentClass = '';
                    
                    if (align === 'left') {
                        alignmentClass = 'align-left';
                    } else if (align === 'right') {
                        alignmentClass = 'align-right';
                    } else if (align === 'center') {
                        alignmentClass = 'align-center';
                    }

                    const imageHTML = `
                        <div class="resizable-image-container ${alignmentClass}" data-image-id="${imageId}">
                            <img src="${src}" class="resizable-image" style="${style}" alt="" data-image-id="${imageId}">
                            <div class="resize-handle nw"></div>
                            <div class="resize-handle ne"></div>
                            <div class="resize-handle sw"></div>
                            <div class="resize-handle se"></div>
                            <div class="resize-handle n"></div>
                            <div class="resize-handle s"></div>
                            <div class="resize-handle e"></div>
                            <div class="resize-handle w"></div>
                        </div>
                    `;

                    document.execCommand('insertHTML', false, imageHTML + '<p><br></p>');

                    setTimeout(() => initializeImageResize(), 100);

                    urlInput.value = '';
                    fileInput.value = null;
                    document.getElementById('imageWidth').value = '';
                    document.getElementById('imageHeight').value = '';
                    document.getElementById('imageAlign').value = 'none';
                    document.getElementById('imageModal').style.display = 'none';
                    window.editorUtils?.updatePreview();
                };

                if (fileInput.files && fileInput.files[0]) {
                    // Upload file to server instead of converting to base64
                    uploadImageFile(fileInput.files[0], applyImageToEditor);
                } else if (urlInput.value) {
                    applyImageToEditor(urlInput.value);
                }
            });

            // Video Modal functionality
            document.getElementById('insertVideo').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('videoModal').style.display = 'flex';
            });

            document.getElementById('cancelVideo').addEventListener('click', () => document.getElementById('videoModal').style.display = 'none');
            
            document.getElementById('applyVideo').addEventListener('click', () => {
                const urlInput = document.getElementById('videoUrl');
                const fileInput = document.getElementById('videoUpload');
                let width = document.getElementById('videoWidth').value.trim();
                let height = document.getElementById('videoHeight').value.trim();
                const align = document.getElementById('videoAlign').value;

                if (width && /^\d+$/.test(width)) width += 'px';
                if (height && /^\d+$/.test(height)) height += 'px';

                const applyVideoToEditor = (src) => {
                    let style = `max-width: 100%; display: block;`;
                    if (width) style += ` width: ${width};`;
                    if (height) style += ` height: ${height};`;
                    else if(width) style += ' height: auto;';

                    if (align === 'left') style += ' float: left; margin-right: 1rem; margin-bottom: 0.5rem;';
                    if (align === 'right') style += ' float: right; margin-left: 1rem; margin-bottom: 0.5rem;';

                    const videoHTML = `<video controls src="${src}" style="${style}">Your browser does not support the video tag.</video>`;
                    document.execCommand('insertHTML', false, videoHTML + "<br>");

                    urlInput.value = '';
                    fileInput.value = null;
                    document.getElementById('videoModal').style.display = 'none';
                    window.editorUtils?.updatePreview();
                };

                if (fileInput.files && fileInput.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                       applyVideoToEditor(e.target.result);
                    }
                    reader.readAsDataURL(fileInput.files[0]);
                } else if (urlInput.value) {
                    applyVideoToEditor(urlInput.value);
                }
            });

            // Enhanced Table functionality
            document.getElementById('insertTable').addEventListener('click', () => {
                const tableHTML = `
                    <div class="table-wrapper" style="position: relative; margin: 1rem 0; display: inline-block;">
                        <table class="enhanced-table" style="width:100%; border-collapse: collapse; min-width: 400px;">
                            <thead>
                                <tr>
                                    <th contenteditable="true" style="border: 1px solid #ccc; padding: 8px; background: #f5f5f5;">Header 1</th>
                                    <th contenteditable="true" style="border: 1px solid #ccc; padding: 8px; background: #f5f5f5;">Header 2</th>
                                    <th contenteditable="true" style="border: 1px solid #ccc; padding: 8px; background: #f5f5f5;">Header 3</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td contenteditable="true" style="border: 1px solid #ccc; padding: 8px;">Cell 1</td>
                                    <td contenteditable="true" style="border: 1px solid #ccc; padding: 8px;">Cell 2</td>
                                    <td contenteditable="true" style="border: 1px solid #ccc; padding: 8px;">Cell 3</td>
                                </tr>
                                <tr>
                                    <td contenteditable="true" style="border: 1px solid #ccc; padding: 8px;">Cell 4</td>
                                    <td contenteditable="true" style="border: 1px solid #ccc; padding: 8px;">Cell 5</td>
                                    <td contenteditable="true" style="border: 1px solid #ccc; padding: 8px;">Cell 6</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <p><br></p>
                `;
                document.execCommand('insertHTML', false, tableHTML);
                initializeTableControls();
            });

            function initializeTableControls() {
                
                const tables = editor.querySelectorAll('.enhanced-table');
                tables.forEach(addTableControls);

                addTableKeyboardHandlers();
            }

            function addTableControls(table) {
                const wrapper = table.closest('.table-wrapper') || table.parentNode;

                const existingControls = wrapper.querySelectorAll('.table-control');
                existingControls.forEach(control => control.remove());

                const addRowBtn = document.createElement('button');
                addRowBtn.className = 'table-control add-row-btn';
                addRowBtn.innerHTML = '<span class="material-symbols-outlined">add</span>';
                addRowBtn.title = 'Add Row';
                addRowBtn.style.cssText = `
                    position: absolute;
                    bottom: -15px;
                    right: 50%;
                    transform: translateX(50%);
                    width: 30px;
                    height: 30px;
                    border-radius: 50%;
                    background: #3b82f6;
                    color: white;
                    border: none;
                    cursor: pointer;
                    display: none;
                    align-items: center;
                    justify-content: center;
                    z-index: 10;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                `;

                const addColBtn = document.createElement('button');
                addColBtn.className = 'table-control add-col-btn';
                addColBtn.innerHTML = '<span class="material-symbols-outlined">add</span>';
                addColBtn.title = 'Add Column';
                addColBtn.style.cssText = `
                    position: absolute;
                    right: -15px;
                    top: 50%;
                    transform: translateY(-50%);
                    width: 30px;
                    height: 30px;
                    border-radius: 50%;
                    background: #3b82f6;
                    color: white;
                    border: none;
                    cursor: pointer;
                    display: none;
                    align-items: center;
                    justify-content: center;
                    z-index: 10;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                `;
                
                wrapper.style.position = 'relative';
                wrapper.appendChild(addRowBtn);
                wrapper.appendChild(addColBtn);

                wrapper.addEventListener('mouseenter', () => {
                    addRowBtn.style.display = 'flex';
                    addColBtn.style.display = 'flex';
                });
                
                wrapper.addEventListener('mouseleave', () => {
                    addRowBtn.style.display = 'none';
                    addColBtn.style.display = 'none';
                });

                addRowBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    addTableRow(table);
                });
                
                addColBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    addTableColumn(table);
                });
            }
            
            function addTableRow(table) {
                const tbody = table.querySelector('tbody');
                const lastRow = tbody.querySelector('tr:last-child');
                const cellCount = lastRow.cells.length;
                
                const newRow = document.createElement('tr');
                for (let i = 0; i < cellCount; i++) {
                    const newCell = document.createElement('td');
                    newCell.style.cssText = 'border: 1px solid #ccc; padding: 8px;';
                    newCell.contentEditable = true;
                    newCell.textContent = 'New cell';
                    newRow.appendChild(newCell);
                }
                
                tbody.appendChild(newRow);

                newRow.cells[0].focus();
                window.editorUtils?.updatePreview();
            }
            
            function addTableColumn(table) {
                const headerRow = table.querySelector('thead tr');
                const bodyRows = table.querySelectorAll('tbody tr');

                const newHeaderCell = document.createElement('th');
                newHeaderCell.style.cssText = 'border: 1px solid #ccc; padding: 8px; background: #f5f5f5;';
                newHeaderCell.contentEditable = true;
                newHeaderCell.textContent = 'Header';
                headerRow.appendChild(newHeaderCell);

                bodyRows.forEach(row => {
                    const newCell = document.createElement('td');
                    newCell.style.cssText = 'border: 1px solid #ccc; padding: 8px;';
                    newCell.contentEditable = true;
                    newCell.textContent = 'Cell';
                    row.appendChild(newCell);
                });

                newHeaderCell.focus();
                window.editorUtils?.updatePreview();
            }
            
            function addTableKeyboardHandlers() {
                editor.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        const activeElement = document.activeElement;

                        if (activeElement.tagName === 'TD' || activeElement.tagName === 'TH') {
                            const table = activeElement.closest('table');
                            const currentRow = activeElement.closest('tr');
                            const tbody = table.querySelector('tbody');
                            const lastRow = tbody.querySelector('tr:last-child');

                            if (currentRow === lastRow && activeElement === currentRow.cells[currentRow.cells.length - 1]) {
                                e.preventDefault();
                                addTableRow(table);
                                return;
                            }
                        }
                    }

                    if (e.key === 'Tab') {
                        const activeElement = document.activeElement;
                        if (activeElement.tagName === 'TD' || activeElement.tagName === 'TH') {
                            e.preventDefault();
                            
                            const table = activeElement.closest('table');
                            const allCells = Array.from(table.querySelectorAll('td, th'));
                            const currentIndex = allCells.indexOf(activeElement);
                            
                            if (e.shiftKey) {
                                // Previous cell
                                const prevIndex = currentIndex > 0 ? currentIndex - 1 : allCells.length - 1;
                                allCells[prevIndex].focus();
                            } else {
                                // Next cell
                                const nextIndex = currentIndex < allCells.length - 1 ? currentIndex + 1 : 0;
                                allCells[nextIndex].focus();
                            }
                        }
                    }
                });
            }

            editor.addEventListener('input', () => {
                
                const tables = editor.querySelectorAll('.enhanced-table:not([data-controls-added])');
                tables.forEach(table => {
                    table.setAttribute('data-controls-added', 'true');
                    addTableControls(table);
                });
            });

            setTimeout(initializeTableControls, 100);
        });
    </script>

    <div id="contextMenu" class="context-menu-container">
        
        <div class="context-menu-item" data-action="copy">
            <span class="material-symbols-outlined text-gray-500">content_copy</span>
            <span>Copy</span>
        </div>
        <div class="context-menu-item" data-action="paste">
            <span class="material-symbols-outlined text-gray-500">content_paste</span>
            <span>Paste</span>
        </div>
        <div class="border-t border-gray-200 my-1"></div>

        <div class="context-menu-item" data-action="addUrl">
            <span class="material-symbols-outlined text-gray-500">link</span>
            <span>Add URL</span>
        </div>
        <div class="border-t border-gray-200 my-1"></div>

        <div class="context-menu-item" data-action="changeTone">
            <span class="material-symbols-outlined text-gray-500">tune</span>
            <span>Change Tone</span>
            <span class="material-symbols-outlined text-gray-400 ml-auto">chevron_right</span>
        </div>
        <div class="context-menu-item" data-action="checkGrammar">
            <span class="material-symbols-outlined text-gray-500">spellcheck</span>
            <span>Check Grammar</span>
        </div>
        <div class="context-menu-item" data-action="improveText">
            <span class="material-symbols-outlined text-gray-500">auto_fix_high</span>
            <span>Improve Text</span>
        </div>
        <div class="context-menu-item" data-action="summarize">
            <span class="material-symbols-outlined text-gray-500">summarize</span>
            <span>Summarize</span>
        </div>
    </div>

    <div id="toneSubmenu" class="fixed bg-white shadow-lg border border-gray-300 rounded-lg py-2 z-50 hidden min-w-40">
        <div class="context-menu-item px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer" data-tone="professional">
            <span>Professional</span>
        </div>
        <div class="context-menu-item px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer" data-tone="soft">
            <span>Soft</span>
        </div>
        <div class="context-menu-item px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer" data-tone="casual">
            <span>Casual</span>
        </div>
        <div class="context-menu-item px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer" data-tone="formal">
            <span>Formal</span>
        </div>
        <div class="context-menu-item px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer" data-tone="friendly">
            <span>Friendly</span>
        </div>
        <div class="context-menu-item px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer" data-tone="confident">
            <span>Confident</span>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const editor = document.getElementById('editor');
            const contextMenu = document.getElementById('contextMenu');
            const toneSubmenu = document.getElementById('toneSubmenu');
            let selectedText = '';
            let currentSelection = null;

            // Global error and success handling
            window.showErrorModal = function(title, message, type = 'error') {
                const modal = document.getElementById('errorModal');
                const titleEl = document.getElementById('errorTitle');
                const messageEl = document.getElementById('errorMessage');
                const iconEl = document.getElementById('errorIcon');
                
                titleEl.textContent = title;
                messageEl.textContent = message;
                
                // Set icon and color based on type
                if (type === 'warning') {
                    iconEl.className = 'w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center';
                    iconEl.querySelector('span').textContent = 'warning';
                    iconEl.querySelector('span').className = 'material-symbols-outlined text-yellow-600 text-xl';
                } else {
                    iconEl.className = 'w-10 h-10 bg-red-100 rounded-full flex items-center justify-center';
                    iconEl.querySelector('span').textContent = 'error';
                    iconEl.querySelector('span').className = 'material-symbols-outlined text-red-600 text-xl';
                }
                
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            };

            window.showSuccessModal = function(title, message) {
                const modal = document.getElementById('successModal');
                const titleEl = document.getElementById('successTitle');
                const messageEl = document.getElementById('successMessage');
                
                titleEl.textContent = title;
                messageEl.textContent = message;
                
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                
                // Auto close after 3 seconds
                setTimeout(() => {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                }, 3000);
            };

            // Close modal handlers
            document.getElementById('closeErrorModal').addEventListener('click', () => {
                document.getElementById('errorModal').classList.add('hidden');
                document.getElementById('errorModal').classList.remove('flex');
            });

            document.getElementById('closeSuccessModal').addEventListener('click', () => {
                document.getElementById('successModal').classList.add('hidden');
                document.getElementById('successModal').classList.remove('flex');
            });

            // Close modals on backdrop click
            document.getElementById('errorModal').addEventListener('click', (e) => {
                if (e.target.id === 'errorModal') {
                    document.getElementById('errorModal').classList.add('hidden');
                    document.getElementById('errorModal').classList.remove('flex');
                }
            });

            document.getElementById('successModal').addEventListener('click', (e) => {
                if (e.target.id === 'successModal') {
                    document.getElementById('successModal').classList.add('hidden');
                    document.getElementById('successModal').classList.remove('flex');
                }
            });

            // Enhanced context menu with better positioning and selection handling
            function handleContextMenu(e) {
                // Check if right-click is within editor area
                const editorRect = editor.getBoundingClientRect();
                const isInEditor = e.clientX >= editorRect.left && 
                                 e.clientX <= editorRect.right && 
                                 e.clientY >= editorRect.top && 
                                 e.clientY <= editorRect.bottom;
                
                if (!isInEditor) return; // Let default behavior for non-editor areas
                
                e.preventDefault();
                e.stopPropagation();
                
                console.log('Context menu triggered at:', e.clientX, e.clientY);
                
                // Always get fresh selection state
                const selection = window.getSelection();
                selectedText = selection.toString().trim();
                currentSelection = selection.rangeCount > 0 ? selection.getRangeAt(0).cloneRange() : null;
                
                console.log('Fresh selection - Selected text:', selectedText, 'Has selection:', !!currentSelection);
                
                // Show context menu for both selected text and general right-click
                showContextMenu(e.pageX, e.pageY, selectedText.length > 0);
            }
            
            // Attach context menu event listener
            editor.addEventListener('contextmenu', handleContextMenu, { passive: false });
            
            console.log('Context menu event listeners attached to editor');            // Ensure editor is properly configured
            if (editor.hasAttribute('disabled')) {
                editor.removeAttribute('disabled');
            }
            
            // Make sure editor is focusable
            if (!editor.hasAttribute('tabindex')) {
                editor.setAttribute('tabindex', '0');
            }

            function showContextMenu(x, y, hasSelection) {
                console.log('showContextMenu called:', x, y, hasSelection); // Debug log
                
                // Ensure context menu exists
                if (!contextMenu) {
                    console.error('Context menu element not found');
                    return;
                }
                
                // Force hide any existing menus first
                contextMenu.style.display = 'none';
                contextMenu.classList.remove('visible');
                contextMenu.classList.add('hidden');
                
                // Small delay to ensure clean state
                setTimeout(() => {
                    // Position context menu
                    contextMenu.style.left = x + 'px';
                    contextMenu.style.top = y + 'px';
                    contextMenu.style.display = 'block'; // Ensure it's displayed
                    contextMenu.classList.remove('hidden');
                    contextMenu.classList.add('visible');
                    toneSubmenu?.classList.add('hidden');
                    
                    console.log('Context menu positioned and shown at:', x, y); // Debug log
                    console.log('Context menu computed style:', window.getComputedStyle(contextMenu).display);
                    console.log('Context menu classes:', contextMenu.className);
                }, 10);
                
                // Adjust position if menu goes off-screen
                setTimeout(() => {
                    const rect = contextMenu.getBoundingClientRect();
                    const viewportWidth = window.innerWidth;
                    const viewportHeight = window.innerHeight;
                    
                    let newX = x;
                    let newY = y;
                    
                    if (rect.right > viewportWidth) {
                        newX = x - rect.width;
                        contextMenu.style.left = newX + 'px';
                    }
                    if (rect.bottom > viewportHeight) {
                        newY = y - rect.height;
                        contextMenu.style.top = newY + 'px';
                    }
                    
                    console.log('Context menu position adjusted:', newX, newY); // Debug log
                }, 10);
                
                // Enable/disable menu items based on selection and clipboard
                updateMenuItemAvailability(hasSelection);
                
                console.log('Context menu items updated'); // Debug log
            }

            function hideContextMenu() {
                console.log('Hiding context menu'); // Debug log
                contextMenu?.classList.remove('visible');
                contextMenu?.classList.add('hidden');
                if (contextMenu) contextMenu.style.display = 'none';
                toneSubmenu?.classList.add('hidden');
                
                // Don't reset selection variables here as they might be needed for pending actions
                console.log('Context menu hidden'); // Debug log
            }

            async function updateMenuItemAvailability(hasSelection) {
                const menuItems = contextMenu.querySelectorAll('[data-action]');
                
                // Check clipboard permission for paste
                let canPaste = false;
                try {
                    const permission = await navigator.permissions.query({name: 'clipboard-read'});
                    canPaste = permission.state === 'granted' || permission.state === 'prompt';
                } catch (e) {
                    canPaste = true; // Assume available if permission check fails
                }
                
                menuItems.forEach(item => {
                    const action = item.dataset.action;
                    item.classList.remove('disabled', 'opacity-50', 'pointer-events-none');
                    
                    switch(action) {
                        case 'copy':
                            // Copy requires text selection
                            if (!hasSelection) {
                                item.classList.add('disabled');
                            }
                            break;
                        case 'paste':
                            // Paste is available if clipboard API supported
                            if (!canPaste) {
                                item.classList.add('disabled');
                            }
                            break;
                        case 'addUrl':
                            // Add URL is always available
                            break;
                        default:
                            // AI actions require text selection
                            if (!hasSelection) {
                                item.classList.add('disabled');
                            }
                            break;
                    }
                });
            }

            // Handle tone submenu with better responsiveness
            contextMenu.addEventListener('mouseover', (e) => {
                const menuItem = e.target.closest('.context-menu-item');
                if (menuItem && menuItem.dataset.action === 'changeTone') {
                    const rect = menuItem.getBoundingClientRect();
                    toneSubmenu.style.left = (rect.right + 5) + 'px';
                    toneSubmenu.style.top = rect.top + 'px';
                    toneSubmenu.classList.remove('hidden');
                } else {
                    // Add small delay to prevent flickering
                    setTimeout(() => {
                        if (!toneSubmenu.matches(':hover') && !contextMenu.querySelector('[data-action="changeTone"]:hover')) {
                            toneSubmenu.classList.add('hidden');
                        }
                    }, 100);
                }
            });

            // Keep submenu open when hovering over it
            toneSubmenu.addEventListener('mouseover', () => {
                toneSubmenu.classList.remove('hidden');
            });

            toneSubmenu.addEventListener('mouseleave', () => {
                toneSubmenu.classList.add('hidden');
            });

            // Handle context menu actions
            contextMenu.addEventListener('click', async (e) => {
                const menuItem = e.target.closest('.context-menu-item');
                if (!menuItem || menuItem.classList.contains('disabled')) return;
                
                const action = menuItem.dataset.action;
                if (!action) return;
                
                // Hide context menu for most actions
                if (action !== 'changeTone') {
                    hideContextMenu();
                }

                try {
                    switch (action) {
                        case 'copy':
                            await handleCopy();
                            break;
                        case 'paste':
                            await handlePaste();
                            break;
                        case 'addUrl':
                            // Trigger the link modal from editor-core.js
                            const createLinkBtn = document.getElementById('createLink');
                            if (createLinkBtn) {
                                createLinkBtn.click();
                            }
                            break;
                        case 'changeTone':
                            // Let submenu handle this - don't hide menu
                            return;
                        case 'checkGrammar':
                        case 'improveText':
                        case 'summarize':
                            await handleAIAction(action);
                            break;
                    }
                } catch (error) {
                    console.error('Context menu action failed:', error);
                    window.editorUtils?.flash(' Action failed. Please try again.');
                }
            });

            // Handle copy functionality
            async function handleCopy() {
                if (!selectedText) {
                    window.editorUtils?.flash(' No text selected to copy');
                    return;
                }

                try {
                    await navigator.clipboard.writeText(selectedText);
                    window.editorUtils?.flash(' Text copied to clipboard!');
                } catch (error) {
                    console.error('Copy failed:', error);
                    // Fallback: try older method
                    try {
                        document.execCommand('copy');
                        window.editorUtils?.flash(' Text copied to clipboard!');
                    } catch (fallbackError) {
                        window.editorUtils?.flash(' Failed to copy text');
                    }
                }
            }

            // Handle paste functionality
            async function handlePaste() {
                try {
                    const clipboardText = await navigator.clipboard.readText();
                    if (clipboardText) {
                        insertTextAtCursor(clipboardText);
                        window.editorUtils?.flash(' Text pasted!');
                        window.editorUtils?.updatePreview();
                        window.editorUtils?.updateUndoRedoButtons();
                    } else {
                        window.editorUtils?.flash(' Clipboard is empty');
                    }
                } catch (error) {
                    console.error('Paste failed:', error);
                    window.editorUtils?.flash(' Failed to paste. Try using Ctrl+V');
                }
            }

            // Handle AI actions
            async function handleAIAction(action) {
                if (!selectedText) {
                    window.editorUtils?.flash(' Please select text first');
                    return;
                }

                // Show loading indicator
                window.editorUtils?.flash('Processing with AI...', 1000);

                try {
                    let result;
                    switch (action) {
                        case 'checkGrammar':
                            result = await window.editorUtils.callAi('/api/ai/grammar-fix', { text: selectedText });
                            replaceSelectedText(result.corrected || result.fixed || selectedText);
                            window.editorUtils?.flash(' Grammar checked and fixed!');
                            break;
                        case 'improveText':
                            result = await window.editorUtils.callAi('/api/ai/improve', { text: selectedText });
                            replaceSelectedText(result.improved || selectedText);
                            window.editorUtils?.flash(' Text improved!');
                            break;
                        case 'summarize':
                            result = await window.editorUtils.callAi('/api/ai/summarize', { text: selectedText });
                            replaceSelectedText(result.summary || selectedText);
                            window.editorUtils?.flash(' Text summarized!');
                            break;
                    }
                } catch (error) {
                    console.error('AI action failed:', error);
                    window.editorUtils?.flash(' Failed to process text. Please try again.');
                }
            }

            // Insert text at cursor position
            function insertTextAtCursor(text) {
                const selection = window.getSelection();
                let range;

                if (selection.rangeCount > 0) {
                    range = selection.getRangeAt(0);
                } else {
                    // Insert at end of editor if no selection
                    range = document.createRange();
                    range.selectNodeContents(editor);
                    range.collapse(false);
                }

                // If there's selected text, replace it
                if (!range.collapsed) {
                    range.deleteContents();
                }

                // Insert the new text
                const textNode = document.createTextNode(text);
                range.insertNode(textNode);
                
                // Move cursor after inserted text
                range.setStartAfter(textNode);
                range.collapse(true);
                selection.removeAllRanges();
                selection.addRange(range);
            }

            // Handle tone submenu clicks
            toneSubmenu.addEventListener('click', async (e) => {
                const tone = e.target.dataset.tone;
                if (!tone || !selectedText) return;

                contextMenu.classList.add('hidden');
                toneSubmenu.classList.add('hidden');

                // Show immediate feedback
                window.editorUtils?.flash(` Changing tone to ${tone}...`, 1500);

                try {
                    const result = await window.editorUtils.callAi('/api/ai/tone/rewrite', { 
                        text: selectedText, 
                        tone: tone 
                    });
                    
                    if (result.rewrite && result.rewrite !== selectedText) {
                        replaceSelectedText(result.rewrite);
                        window.editorUtils?.flash(` Changed tone to ${tone}!`);
                    } else {
                        window.editorUtils?.flash(` No changes needed for ${tone} tone.`);
                    }
                } catch (error) {
                    console.error('Tone change failed:', error);
                    window.editorUtils?.flash(` Failed to change tone to ${tone}. Please try again.`);
                }
            });

            // Function to replace selected text
            function replaceSelectedText(newText) {
                if (!currentSelection) {
                    window.editorUtils?.flash(' No text selected');
                    return;
                }
                
                try {
                    // Restore the selection
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(currentSelection);
                    
                    // Replace the content
                    currentSelection.deleteContents();
                    currentSelection.insertNode(document.createTextNode(newText));
                    
                    // Clear selection
                    selection.removeAllRanges();
                    currentSelection = null;
                    selectedText = '';
                    
                    // Update editor
                    window.editorUtils?.updatePreview();
                    window.editorUtils?.updateUndoRedoButtons();
                } catch (error) {
                    console.error('Failed to replace text:', error);
                    window.editorUtils?.flash(' Failed to replace text');
                }
            }

            // Improved event handling for hiding context menu
            document.addEventListener('click', (e) => {
                // Don't hide if clicking on context menu or its children
                if (contextMenu?.contains(e.target) || toneSubmenu?.contains(e.target)) {
                    return;
                }
                
                // Hide both menus
                hideContextMenu();
            });
            
            // Hide context menu on scroll or resize
            document.addEventListener('scroll', hideContextMenu);
            window.addEventListener('resize', hideContextMenu);
            
            // Hide context menu on keyboard events
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' || e.key === 'Tab') {
                    hideContextMenu();
                }
            });

            // Image Resize Functionality
            function initializeImageResize() {
                const editor = document.getElementById('editor');
                const containers = editor.querySelectorAll('.resizable-image-container');
                
                containers.forEach(container => {
                    if (container.dataset.resizeInitialized) return;
                    container.dataset.resizeInitialized = 'true';
                    
                    const img = container.querySelector('.resizable-image');
                    const handles = container.querySelectorAll('.resize-handle');
                    
                    // Image selection
                    img.addEventListener('click', (e) => {
                        e.stopPropagation();
                        selectImage(container);
                    });
                    
                    // Add resize functionality to each handle
                    handles.forEach(handle => {
                        handle.addEventListener('mousedown', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            startResize(e, container, handle.className.split(' ')[1]);
                        });
                    });
                });
            }
            
            function selectImage(container) {
                // Deselect all other images
                const allContainers = editor.querySelectorAll('.resizable-image-container');
                allContainers.forEach(c => {
                    c.classList.remove('selected');
                    c.querySelector('.resizable-image').classList.remove('selected');
                });
                
                // Select this image
                container.classList.add('selected');
                container.querySelector('.resizable-image').classList.add('selected');
                
                // Update alignment buttons to reflect current image alignment
                updateAlignmentButtonsForImage(container);
            }

            function updateAlignmentButtonsForImage(container) {
                const alignmentButtons = {
                    'justifyLeft': document.getElementById('justifyLeft'),
                    'justifyCenter': document.getElementById('justifyCenter'),
                    'justifyRight': document.getElementById('justifyRight')
                };

                // Remove active class from all alignment buttons
                Object.values(alignmentButtons).forEach(btn => {
                    if (btn) btn.classList.remove('active');
                });

                // Add active class based on container's alignment class
                if (container.classList.contains('align-left') && alignmentButtons.justifyLeft) {
                    alignmentButtons.justifyLeft.classList.add('active');
                } else if (container.classList.contains('align-center') && alignmentButtons.justifyCenter) {
                    alignmentButtons.justifyCenter.classList.add('active');
                } else if (container.classList.contains('align-right') && alignmentButtons.justifyRight) {
                    alignmentButtons.justifyRight.classList.add('active');
                }
            }
            
            function startResize(e, container, direction) {
                const img = container.querySelector('.resizable-image');
                const startX = e.clientX;
                const startY = e.clientY;
                const startWidth = img.offsetWidth;
                const startHeight = img.offsetHeight;
                const aspectRatio = startWidth / startHeight;
                
                // Create overlay to prevent text selection
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    cursor: ${getResizeCursor(direction)};
                    z-index: 99999;
                    user-select: none;
                `;
                document.body.appendChild(overlay);
                
                function handleMouseMove(e) {
                    const deltaX = e.clientX - startX;
                    const deltaY = e.clientY - startY;
                    let newWidth = startWidth;
                    let newHeight = startHeight;
                    
                    // Calculate new dimensions based on handle direction
                    switch (direction) {
                        case 'se': // Southeast - proportional resize
                            newWidth = Math.max(50, startWidth + deltaX);
                            newHeight = newWidth / aspectRatio;
                            break;
                        case 'sw': // Southwest
                            newWidth = Math.max(50, startWidth - deltaX);
                            newHeight = newWidth / aspectRatio;
                            break;
                        case 'ne': // Northeast  
                            newWidth = Math.max(50, startWidth + deltaX);
                            newHeight = newWidth / aspectRatio;
                            break;
                        case 'nw': // Northwest
                            newWidth = Math.max(50, startWidth - deltaX);
                            newHeight = newWidth / aspectRatio;
                            break;
                        case 'e': // East - width only
                            newWidth = Math.max(50, startWidth + deltaX);
                            break;
                        case 'w': // West - width only
                            newWidth = Math.max(50, startWidth - deltaX);
                            break;
                        case 's': // South - height only
                            newHeight = Math.max(30, startHeight + deltaY);
                            break;
                        case 'n': // North - height only
                            newHeight = Math.max(30, startHeight - deltaY);
                            break;
                    }
                    
                    // Apply new dimensions
                    img.style.width = newWidth + 'px';
                    if (['n', 's'].includes(direction)) {
                        img.style.height = newHeight + 'px';
                    } else if (['nw', 'ne', 'sw', 'se'].includes(direction)) {
                        img.style.height = newHeight + 'px';
                    } else {
                        img.style.height = 'auto';
                    }
                    
                    // Update preview
                    window.editorUtils?.updatePreview();
                }
                
                function handleMouseUp() {
                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('mouseup', handleMouseUp);
                    document.body.removeChild(overlay);
                    
                    // Save state for undo/redo
                    window.editorUtils?.updateUndoRedoButtons();
                }
                
                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
            }
            
            function getResizeCursor(direction) {
                const cursors = {
                    'nw': 'nw-resize',
                    'ne': 'ne-resize',
                    'sw': 'sw-resize', 
                    'se': 'se-resize',
                    'n': 'n-resize',
                    's': 's-resize',
                    'e': 'e-resize',
                    'w': 'w-resize'
                };
                return cursors[direction] || 'default';
            }
            
            // Deselect images when clicking elsewhere
            editor.addEventListener('click', (e) => {
                if (!e.target.closest('.resizable-image-container')) {
                    const allContainers = editor.querySelectorAll('.resizable-image-container');
                    allContainers.forEach(c => {
                        c.classList.remove('selected');
                        c.querySelector('.resizable-image').classList.remove('selected');
                    });
                    
                    // Reset alignment buttons to text mode when no image is selected
                    resetAlignmentButtonsToText();
                }
            });

            function resetAlignmentButtonsToText() {
                const alignmentButtons = {
                    'justifyLeft': document.getElementById('justifyLeft'),
                    'justifyCenter': document.getElementById('justifyCenter'),
                    'justifyRight': document.getElementById('justifyRight')
                };

                // Remove active class from all alignment buttons
                Object.values(alignmentButtons).forEach(btn => {
                    if (btn) btn.classList.remove('active');
                });

                // Check current text alignment and set appropriate button active
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const element = selection.getRangeAt(0).commonAncestorContainer;
                    let node = element.nodeType === Node.TEXT_NODE ? element.parentNode : element;
                    
                    // Walk up to find alignment
                    while (node && node !== editor) {
                        const style = window.getComputedStyle(node);
                        const textAlign = style.textAlign;
                        
                        if (textAlign === 'center' && alignmentButtons.justifyCenter) {
                            alignmentButtons.justifyCenter.classList.add('active');
                            break;
                        } else if (textAlign === 'right' && alignmentButtons.justifyRight) {
                            alignmentButtons.justifyRight.classList.add('active');
                            break;
                        } else if ((textAlign === 'left' || textAlign === 'start') && alignmentButtons.justifyLeft) {
                            alignmentButtons.justifyLeft.classList.add('active');
                            break;
                        }
                        
                        node = node.parentNode;
                    }
                }
            }
            
            // Keyboard shortcuts for image resizing
            editor.addEventListener('keydown', (e) => {
                const selectedContainer = editor.querySelector('.resizable-image-container.selected');
                if (!selectedContainer) return;
                
                const img = selectedContainer.querySelector('.resizable-image');
                if (!img) return;
                
                const step = e.shiftKey ? 10 : 5; // Larger steps with Shift
                let currentWidth = img.offsetWidth;
                let currentHeight = img.offsetHeight;
                
                switch (e.key) {
                    case 'ArrowLeft':
                        if (e.ctrlKey || e.metaKey) {
                            e.preventDefault();
                            img.style.width = Math.max(50, currentWidth - step) + 'px';
                            if (!e.altKey) img.style.height = 'auto';
                            window.editorUtils?.updatePreview();
                        }
                        break;
                    case 'ArrowRight':
                        if (e.ctrlKey || e.metaKey) {
                            e.preventDefault();
                            img.style.width = (currentWidth + step) + 'px';
                            if (!e.altKey) img.style.height = 'auto';
                            window.editorUtils?.updatePreview();
                        }
                        break;
                    case 'ArrowUp':
                        if (e.ctrlKey || e.metaKey) {
                            e.preventDefault();
                            if (e.altKey) {
                                img.style.height = Math.max(30, currentHeight - step) + 'px';
                            }
                        }
                        break;
                    case 'ArrowDown':
                        if (e.ctrlKey || e.metaKey) {
                            e.preventDefault();
                            if (e.altKey) {
                                img.style.height = (currentHeight + step) + 'px';
                            }
                        }
                        break;
                    case 'Delete':
                    case 'Backspace':
                        e.preventDefault();
                        selectedContainer.remove();
                        window.editorUtils?.updatePreview();
                        window.editorUtils?.updateUndoRedoButtons();
                        break;
                }
            });

            // Initialize existing images on load
            document.addEventListener('DOMContentLoaded', () => {
                initializeImageResize();
            });
            
            // Re-initialize images after content updates
            if (window.editorUtils) {
                const originalUpdatePreview = window.editorUtils.updatePreview;
                window.editorUtils.updatePreview = function() {
                    if (originalUpdatePreview) originalUpdatePreview.call(this);
                    setTimeout(initializeImageResize, 50);
                };
            }

            // Initial context menu setup
            console.log('Context menu initialized. Use Ctrl+M to test or window.testContextMenu()');

            if (window.seoTools) {
                seoTools.init();

                setTimeout(() => {
                    // Use sidebar fields as primary SEO settings fields
                    const metaDescField = document.getElementById('seo-meta-description-sidebar');
                    const focusKeywordField = document.getElementById('seo-focus-keyword-sidebar');
                    const slugField = document.getElementById('seo-slug-sidebar');

                    const metaDescSidebarField = document.getElementById('seo-meta-description-sidebar');
                    const focusKeywordSidebarField = document.getElementById('seo-focus-keyword-sidebar');
                    const slugSidebarField = document.getElementById('seo-slug-sidebar');
                    const canonicalSidebarField = document.getElementById('seo-canonical-sidebar');
                    const ogTitleSidebarField = document.getElementById('seo-og-title-sidebar');
                    const ogDescriptionSidebarField = document.getElementById('seo-og-description-sidebar');
                    
                                        const serverSEORaw = `
<%- JSON.stringify({
    metaDescription: (typeof metaDescription !== 'undefined' ? metaDescription : null),
    focusKeyword: (typeof focusKeyword !== 'undefined' ? focusKeyword : null),
    urlSlug: (typeof urlSlug !== 'undefined' ? urlSlug : null),
    canonicalUrl: (typeof canonicalUrl !== 'undefined' ? canonicalUrl : null),
    ogTitle: (typeof ogTitle !== 'undefined' ? ogTitle : null),
    ogDescription: (typeof ogDescription !== 'undefined' ? ogDescription : null),
    seoAnalysis: (typeof seoAnalysis !== 'undefined' ? seoAnalysis : null)
}) %>`;
                                        const serverSEO = (() => { try { return JSON.parse(serverSEORaw || '{}'); } catch (_) { return {}; } })();

                    if (serverSEO.metaDescription) {
                        if (metaDescField) metaDescField.value = serverSEO.metaDescription;
                        if (metaDescSidebarField) metaDescSidebarField.value = serverSEO.metaDescription;
                    }
                    if (serverSEO.focusKeyword) {
                        if (focusKeywordField) focusKeywordField.value = serverSEO.focusKeyword;
                        if (focusKeywordSidebarField) focusKeywordSidebarField.value = serverSEO.focusKeyword;
                    }
                    if (serverSEO.urlSlug) {
                        if (slugField) slugField.value = serverSEO.urlSlug;
                        if (slugSidebarField) slugSidebarField.value = serverSEO.urlSlug;
                    }
                    if (serverSEO.canonicalUrl) {
                        if (canonicalSidebarField) canonicalSidebarField.value = serverSEO.canonicalUrl;
                    }
                    if (serverSEO.ogTitle) {
                        if (ogTitleSidebarField) ogTitleSidebarField.value = serverSEO.ogTitle;
                    }
                    if (serverSEO.ogDescription) {
                        if (ogDescriptionSidebarField) ogDescriptionSidebarField.value = serverSEO.ogDescription;
                    }
                    if (serverSEO.seoAnalysis) {
                        seoTools.analysisResult = serverSEO.seoAnalysis;
                        if (seoTools.analysisResult) {
                            seoTools.displayResults(seoTools.analysisResult);
                        }
                    }
                    
                    syncAdvancedSeoHiddenFields();

                    if (seoTools.updateCharCount) {
                        seoTools.updateCharCount();
                    }
                    if (seoTools.updateCharCountSidebar) {
                        seoTools.updateCharCountSidebar();
                    }
                }, 100);
                console.log('SEO Tools initialized with existing data');
            }
        });
    </script>
</body>
</html>
